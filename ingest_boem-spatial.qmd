---
title: "Ingest BOEM Spatial into Database"
author: "Ben Best"
editor_options: 
  chunk_output_type: console
---

## Goals

- [ ] `msens::shlfs|rgns` -> `pg:shlfs|rgns`\
  Ingest existing BOEM Shelfs () and Regions from `msens` R package into `msens` PostGIS spatial database for performing spatial joins with species and other data.
  
- [ ] `aliquots` -> `pg:alqts`\
  Ingest BOEM `aliquots` into the datbase as the finest spatial analytical unit, too big to store in the `msens` R package.

## Shelf > Region

We already ingested [`ply_rgns`](https://marinesensitivity.org/msens/reference/ply_rgns.html) + [`ply_shlfs`](https://marinesensitivity.org/msens/reference/ply_shlfs.html) with [`data-raw/ply_shlfs_rgns.R`](https://github.com/MarineSensitivity/msens/blob/main/data-raw/ply_shlfs_rgns.R) into the `msens` R package after the workflow [explore\_regions](https://marinesensitivity.org/workflows/explore_regions.html).

### Shelf (`shlf`)

```{r}
librarian::shelf(
  here, mapview, 
  marinesensitivity/msens, 
  sf,
  quiet = T)

mapView(
  msens::ply_shlfs_s05,
  zcol       = "shlf_name",
  layer.name = "ply_shlfs.shlf_name<br><small>(simplified to 5%)</small>")
```

### Region (`rgn`)

```{r}
mapView(
  msens::ply_rgns_s05,
  zcol       = "rgn_name",
  layer.name = "ply_rgns.rgn_name<br><small>(simplified to 5%)</small>")
```


### Load into PostGIS

```{r}
source(here("libs/db.R")) # define: con

tbls <- c(
  "ply_shlfs", "ply_shlfs_s05", 
  "ply_rgns" , "ply_rgns_s05")
redo <- F

if (!all(tbls %in% dbListTables(con))){
  for (tbl in tbls){  # tbl = "ply_shlfs_s05"
    st_write(
      get(tbl),
      dsn           = con,
      layer         = tbl,
      driver        = "PostgreSQL",
      layer_options = "OVERWRITE=true")
  }
}

# test
dbListTables(con)

p <- st_read(con, "ply_shlfs_s05")
mapView(
  p,
  zcol       = "shlf_name",
  layer.name = "ply_shlfs.shlf_name<br><small>(simplified to 5%)</small>")
```

## Aliquot (`alqt`)

Shelf > Region > Aliquot

So need to also get identity of aliquot to Region, Shelf.



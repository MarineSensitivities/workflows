<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>GoMex cetacean &amp; sea turtle SDMs</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="ingest_sdm-gm_files/libs/clipboard/clipboard.min.js"></script>
<script src="ingest_sdm-gm_files/libs/quarto-html/quarto.js"></script>
<script src="ingest_sdm-gm_files/libs/quarto-html/popper.min.js"></script>
<script src="ingest_sdm-gm_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="ingest_sdm-gm_files/libs/quarto-html/anchor.min.js"></script>
<link href="ingest_sdm-gm_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="ingest_sdm-gm_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="ingest_sdm-gm_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="ingest_sdm-gm_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="ingest_sdm-gm_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

<script src="ingest_sdm-gm_files/libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="ingest_sdm-gm_files/libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="ingest_sdm-gm_files/libs/datatables-binding-0.31/datatables.js"></script>
<script src="ingest_sdm-gm_files/libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="ingest_sdm-gm_files/libs/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="ingest_sdm-gm_files/libs/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="ingest_sdm-gm_files/libs/dt-core-1.13.6/js/jquery.dataTables.min.js"></script>
<link href="ingest_sdm-gm_files/libs/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet">
<script src="ingest_sdm-gm_files/libs/crosstalk-1.2.1/js/crosstalk.min.js"></script>


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">GoMex cetacean &amp; sea turtle SDMs</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p><a href="https://www.ncei.noaa.gov/access/metadata/landing-page/bin/iso?id=gov.noaa.nodc:256800">Cetacean and sea turtle spatial density model outputs from visual observations using line-transect survey methods aboard NOAA vessel and aircraft platforms in the Gulf of Mexico from 2003-06-12 to 2019-07-31 (NCEI Accession 0256800)</a></p>
<ul>
<li>additional <a href="https://www.fisheries.noaa.gov/inport/item/67830">metadata</a></li>
</ul>
<div class="cell" data-messages="false">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># packages</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  devtools, dplyr, DT, fs, glue, here, janitor, knitr, mapview, purrr, readr, </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  readxl, sf, stringr, tibble, tidyr, units,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">quiet =</span> T)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">readr.show_col_types =</span> F)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">here</span>(<span class="st">"libs/db.R"</span>)) <span class="co"># con</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>create_index <span class="ot">&lt;-</span> <span class="cf">function</span>(con, tbl, flds, <span class="at">schema =</span> <span class="st">"public"</span>, <span class="at">geom=</span>F, <span class="at">unique=</span>F, <span class="at">overwrite=</span>F, <span class="at">show=</span>F, <span class="at">exec=</span>T){</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># tbl = "taxa"; flds = c("tbl_orig", "aphia_id"); unique = T; geom=F</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="sc">!</span>(geom <span class="sc">==</span> T <span class="sc">&amp;</span> <span class="fu">length</span>(flds) <span class="sc">!=</span> <span class="dv">1</span>))</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  sfx <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    geom,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">" USING GIST ({flds})"</span>),</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"({paste(flds, collapse=', ')})"</span>))</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    unique,</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">glue</span>(<span class="st">"{tbl}_unique_idx"</span>),</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">glue</span>(<span class="st">"{tbl}_{paste(flds, collapse='_')}_idx"</span>))</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (overwrite)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dbExecute</span>(con, <span class="fu">glue</span>(<span class="st">"DROP INDEX IF EXISTS {schema}.{idx}"</span>))</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  sql <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"CREATE {ifelse(unique, 'UNIQUE','')} INDEX IF NOT EXISTS {idx} ON {schema}.{tbl}{sfx}"</span>)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (show)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(sql)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (exec)</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dbExecute</span>(con, sql)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>schema <span class="ot">&lt;-</span> <span class="st">"public"</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>d_datasets <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">ds_key      =</span> <span class="st">"gm"</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">name_short  =</span> <span class="st">"NOAA GoMex Cetacean &amp; Sea Turtle Densities"</span>, <span class="co"># short name in form of {source_broad} {regions} {taxa_groups} {response_type}</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">name_full   =</span> <span class="st">"Cetacean and sea turtle spatial density model outputs from visual observations using line-transect survey methods aboard NOAA vessel and aircraft platforms in the Gulf of Mexico from 2003-06-12 to 2019-07-31 (NCEI Accession 0256800)"</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">link        =</span> <span class="st">"https://www.ncei.noaa.gov/access/metadata/landing-page/bin/iso?id=gov.noaa.nodc:256800"</span>,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">citation    =</span> <span class="st">"Litz, Jenny; Aichinger Dias, Laura; Rappucci, Gina; Martinez, Anthony; Soldevilla, Melissa; Garrison, Lance; Mullin, Keith; Barry, Kevin; Foster, Marjorie (2022). Cetacean and sea turtle spatial density model outputs from visual observations using line-transect survey methods aboard NOAA vessel and aircraft platforms in the Gulf of Mexico from 2003-06-12 to 2019-07-31 (NCEI Accession 0256800). [indicate subset used]. NOAA National Centers for Environmental Information. Dataset. https://doi.org/10.25921/efv4-9z56. Accessed July 28, 2022."</span>,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">description =</span> <span class="st">"Based on ship-based and aerial line-transect surveys conducted in the U.S. waters of the Gulf of Mexico between 2003 and 2019, the NOAA Southeast Fisheries Science Center (SEFSC) developed spatial density models (SDMs) for cetacean and sea turtle species for the entire Gulf of Mexico. SDMs were developed using a generalized additive modeling (GAM) framework to determine the relationship between species abundance and environmental variables (monthly averaged oceanographic conditions during 2015 - 2019). Models were extrapolated beyond the U.S. Gulf of Mexico to provide insight into potential high density areas throughout the Gulf of Mexico. However, extrapolations of this type should be interpreted with caution. This dataset includes 19 shapefiles for the SDMs for each cetacean and sea turtle species or species group."</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">response_type  =</span> <span class="st">"density"</span>,             </span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># response_type: one of: occurrence, range, suitability, probability or density</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">taxa_groups     =</span> <span class="st">"cetacean, sea turtle"</span>, </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># taxa_groups: one or more of: fish, invertebrates, marine mammals, cetaceans, sea turtles, seabirds, etc.</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">year_pub       =</span> <span class="dv">2022</span>,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">date_obs_beg   =</span> <span class="st">"2003-06-12"</span>, </span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">date_obs_end   =</span> <span class="st">"2019-08-01"</span>,            <span class="co"># up to, but not including *_end</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">date_env_beg   =</span> <span class="st">"2015-01-01"</span>, </span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">date_env_end   =</span> <span class="st">"2020-01-01"</span>,            <span class="co"># up to, but not including *_end</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">regions        =</span> <span class="fu">list</span>(<span class="st">"Gulf of Mexico"</span>))  <span class="co"># array</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co"># names(d_dataset) |&gt; paste(collapse = ", ") |&gt; cat()</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>t_datasets <span class="ot">&lt;-</span> <span class="fu">Id</span>(<span class="at">schema =</span> schema, <span class="at">table =</span> <span class="st">"sdm_datasets"</span>)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>row_exists <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, t_datasets) <span class="sc">|&gt;</span> <span class="fu">filter</span>(ds_key <span class="sc">==</span> <span class="st">"gm"</span>) <span class="sc">|&gt;</span> <span class="fu">collect</span>() <span class="sc">|&gt;</span> <span class="fu">nrow</span>() <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>row_exists){</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># append, except array columns: regions</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbWriteTable</span>(</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    con, t_datasets, <span class="at">append =</span> T,</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    d_datasets <span class="sc">|&gt;</span> </span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>regions) )</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># append array column: regions</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>  regions_sql <span class="ot">&lt;-</span> <span class="fu">glue</span>(</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ARRAY['{d_datasets$regions |&gt; unlist() |&gt; paste(collapse = ', ')}']"</span>)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbExecute</span>(</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    con, </span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">glue</span>(</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>      <span class="st">"UPDATE sdm_datasets </span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a><span class="st">      SET   regions = {regions_sql}</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a><span class="st">      WHERE ds_key  = 'gm'"</span>) )</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a><span class="fu">tbl</span>(con, t_datasets) <span class="sc">|&gt;</span> </span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ds_key <span class="sc">==</span> <span class="st">"gm"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 1
Columns: 17
$ ds_key        &lt;chr&gt; "gm"
$ name_short    &lt;chr&gt; "NOAA GoMex Cetacean &amp; Sea Turtle Densities"
$ name_full     &lt;chr&gt; "Cetacean and sea turtle spatial density model outputs f…
$ link          &lt;chr&gt; "https://www.ncei.noaa.gov/access/metadata/landing-page/…
$ links_other   &lt;pq__vrch&gt; NA
$ source_broad  &lt;chr&gt; NA
$ source_detail &lt;chr&gt; NA
$ regions       &lt;pq__vrch&gt; {"Gulf of Mexico"}
$ description   &lt;chr&gt; "Based on ship-based and aerial line-transect surveys co…
$ citation      &lt;chr&gt; "Litz, Jenny; Aichinger Dias, Laura; Rappucci, Gina; Mar…
$ response_type &lt;chr&gt; "density"
$ taxa_groups   &lt;chr&gt; "cetacean, sea turtle"
$ year_pub      &lt;int&gt; 2022
$ date_obs_beg  &lt;date&gt; 2003-06-12
$ date_obs_end  &lt;date&gt; 2019-08-01
$ date_env_beg  &lt;date&gt; 2015-01-01
$ date_env_end  &lt;date&gt; 2020-01-01</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># helper functions ----</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>get_annual_density <span class="ot">&lt;-</span> <span class="cf">function</span>(d_sf, <span class="at">i=</span><span class="dv">0</span>){</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># i = 12; d_sf &lt;- d$sf[[i]]</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"{i} of {nrow(d_sf)} in get_annual_density() ~ {Sys.time()}"</span>))</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get geometries</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  geoms <span class="ot">&lt;-</span> d_sf <span class="sc">%&gt;%</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="at">hexid =</span> HEXID, <span class="at">geom =</span> geometry)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get *_n abundance (#/40km2) per month and calculate annual average density (#/km2)</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  mos_n <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{month.abb}_n"</span>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  attrs <span class="ot">&lt;-</span> d_sf <span class="sc">%&gt;%</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="at">hexid =</span> HEXID, <span class="fu">any_of</span>(mos_n)) <span class="sc">%&gt;%</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="sc">-</span>hexid, <span class="at">names_to =</span> <span class="st">"mo_n"</span>, <span class="at">values_to =</span> <span class="st">"n"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(n <span class="sc">!=</span> <span class="sc">-</span><span class="dv">9999</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(hexid) <span class="sc">%&gt;%</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">n =</span> <span class="fu">mean</span>(n),</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">density =</span> n <span class="sc">/</span> <span class="dv">40</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(hexid, density) <span class="co"># individuals / km2</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># return geometries joined with summarized attributes</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  d_sum <span class="ot">&lt;-</span> geoms <span class="sc">%&gt;%</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>      attrs, <span class="at">by =</span> <span class="st">"hexid"</span>)</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>  d_sum</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="co"># read layers ----</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>dir_shp   <span class="ot">&lt;-</span> <span class="st">"/Users/bbest/My Drive/projects/offhab/data/raw/ncei.noaa.gov - GoMex cetacean &amp; sea turtle SDMs/0256800/2.2/data/0-data/NOAA_SEFSC_Cetacean_SeaTurtle_SDM_shapefiles"</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>taxa_xls <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{dir_shp}/../spp_gmx.xlsx"</span>)</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>d_taxa <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(taxa_xls)</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>t_geoms <span class="ot">&lt;-</span> <span class="fu">Id</span>(<span class="at">schema =</span> schema, <span class="at">table =</span> <span class="st">"sdm_geometries"</span>)</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>rows_exist <span class="ot">&lt;-</span> (</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl</span>(con, t_geoms) <span class="sc">|&gt;</span> </span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(ds_key <span class="sc">==</span> <span class="st">"gm"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">collect</span>() <span class="sc">|&gt;</span> </span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nrow</span>() ) <span class="sc">&gt;</span> <span class="dv">1</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>rows_exist){</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">path_shp =</span> <span class="fu">list.files</span>(dir_shp, <span class="st">"shp$"</span>, <span class="at">full.names=</span>T)) <span class="sc">|&gt;</span> </span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>      <span class="at">base_shp =</span> <span class="fu">basename</span>(path_shp) <span class="sc">|&gt;</span> <span class="fu">path_ext_remove</span>(),</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>      <span class="at">taxa_shp =</span> <span class="fu">str_replace</span>(base_shp, <span class="st">"(.*)_Monthly_.*"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>      d_taxa  <span class="sc">|&gt;</span> </span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(taxa_shp, taxa_sci, taxa_doc),</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="st">"taxa_shp"</span>)  <span class="sc">|&gt;</span> </span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>      <span class="at">population =</span> <span class="fu">map_chr</span>(</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>        base_shp, <span class="sc">~</span>{</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (<span class="fu">str_detect</span>(.x, <span class="st">"^(Oceanic)|(Shelf)"</span>)) {</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(<span class="fu">str_replace</span>(.x, <span class="st">"^(Oceanic|Shelf)_(.*)"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>))</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> {</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(<span class="cn">NA</span>)</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>          } }),</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>      <span class="at">sf         =</span> <span class="fu">map</span>(path_shp, read_sf),</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>      <span class="at">d_density  =</span> <span class="fu">imap</span>(sf, get_annual_density),</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>      <span class="at">months_lst =</span> <span class="fu">map</span>(sf, <span class="sc">~</span>{</span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>        <span class="fu">intersect</span>(</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>          <span class="fu">colnames</span>(.),</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>          <span class="fu">glue</span>(<span class="st">"{month.abb}_n"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>          <span class="fu">str_replace</span>(<span class="st">"_n"</span>, <span class="st">""</span>)  }),</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_months =</span> <span class="fu">map_int</span>(months_lst, length),</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>      <span class="at">months   =</span> <span class="fu">map_chr</span>(months_lst, paste, <span class="at">collapse=</span><span class="st">";"</span>) )</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get unique geometries</span></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>  d_geoms <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(sf) <span class="sc">|&gt;</span> </span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>      <span class="at">sf =</span> <span class="fu">map</span>(sf, \(x){ x <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="at">gid =</span> HEXID) } ) ) <span class="sc">|&gt;</span> </span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unnest</span>(<span class="at">cols =</span> <span class="fu">c</span>(sf)) <span class="sc">|&gt;</span> </span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>() <span class="sc">|&gt;</span> </span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(gid) <span class="sc">|&gt;</span> </span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_as_sf</span>() <span class="sc">|&gt;</span> </span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># exclude "POLYGON" whole hexagon duplicates</span></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">st_geometry_type</span>(geometry) <span class="sc">==</span> <span class="st">"MULTIPOLYGON"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">geom_id =</span> gid) <span class="sc">|&gt;</span> </span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>      <span class="at">geom_id =</span> <span class="fu">as.integer</span>(geom_id),</span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>      <span class="at">ds_key  =</span> <span class="st">"gm"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>    <span class="fu">relocate</span>(ds_key, <span class="at">.before =</span> geom_id) <span class="sc">|&gt;</span> </span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="dv">4326</span>) <span class="sc">|&gt;</span> <span class="co"># from: USA_Contiguous_Lambert_Conformal_Conic</span></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mapView(d_geoms)</span></span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_set_geometry</span>(<span class="st">"geom"</span>)</span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_write</span>(d_geoms, con, t_geoms, <span class="at">append =</span> T)</span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> <span class="st">"SELECT * FROM sdm_geometries WHERE ds_key = 'gm'"</span></span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a><span class="co"># st_read(con, query = q) |&gt; </span></span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a><span class="co">#   mapView()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>t_vals <span class="ot">&lt;-</span> <span class="fu">Id</span>(<span class="at">schema =</span> schema, <span class="at">table =</span> <span class="st">"sdm_values"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>rows_exist <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, t_vals) <span class="sc">|&gt;</span> <span class="fu">filter</span>(ds_key <span class="sc">==</span> <span class="st">"gm"</span>) <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">pull</span>() <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>rows_exist){</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get unique values</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  d_vals <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="at">sp_key =</span> taxa_sci, population, <span class="at">data =</span> sf) <span class="sc">|&gt;</span> </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> <span class="fu">map</span>(data, \(x){</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        x <span class="sc">|&gt;</span> </span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>          <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>          <span class="fu">rename</span>(<span class="at">geom_id =</span> HEXID) <span class="sc">|&gt;</span> </span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pivot_longer</span>(</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">cols      =</span> <span class="sc">-</span>geom_id,</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>            <span class="at">names_to  =</span> <span class="st">"mo_var"</span>,</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">values_to =</span> <span class="st">"val"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(val <span class="sc">!=</span> <span class="sc">-</span><span class="dv">9999</span>) <span class="sc">|&gt;</span> </span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>          <span class="fu">separate</span>(</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>            <span class="at">col  =</span> mo_var,</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>            <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"mo"</span>, <span class="st">"var"</span>),</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>            <span class="at">sep  =</span> <span class="st">"_"</span>)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>        } ) ) <span class="sc">|&gt;</span> </span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unnest</span>(<span class="at">cols =</span> <span class="fu">c</span>(data)) <span class="sc">|&gt;</span> </span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">ds_key =</span> <span class="st">"gm"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">relocate</span>(ds_key, <span class="at">.before =</span> taxa_sci)</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># A tibble: 15,445,842 × 7</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>  yr <span class="ot">&lt;-</span> <span class="dv">2019</span> <span class="co"># using last year of obs/env so ISO 8601 compliant</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>  d_vals <span class="ot">&lt;-</span> d_vals <span class="sc">|&gt;</span> </span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>     <span class="at">mm            =</span> <span class="fu">setNames</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>, month.abb)[mo],</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>     <span class="at">mm_str        =</span> stringr<span class="sc">::</span><span class="fu">str_pad</span>(mm, <span class="dv">2</span>, <span class="at">pad =</span> <span class="st">"0"</span>),</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>     <span class="co"># Time Interval notation using [ISO 8601])(https://en.wikipedia.org/wiki/ISO_8601)</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>     <span class="at">time_interval =</span> <span class="fu">glue</span>(<span class="st">"{yr}-{mm_str}/P1M"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>      <span class="sc">-</span>mo, <span class="sc">-</span>mm, <span class="sc">-</span>mm_str)</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># summarize d_vals to d_models</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>  d_mdls <span class="ot">&lt;-</span> d_vals <span class="sc">|&gt;</span> </span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>      ds_key, sp_key, population, time_interval, var) <span class="sc">|&gt;</span> </span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rowid_to_column</span>(<span class="st">"mdl_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>      <span class="at">mdl_id =</span> <span class="st">"gm"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">relocate</span>(ds_key, <span class="at">.before =</span> mdl_id)</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>  d_vals <span class="ot">&lt;-</span> d_vals <span class="sc">|&gt;</span> </span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>      d_models, </span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ds_key"</span>, <span class="st">"sp_key"</span>, <span class="st">"population"</span>, <span class="st">"time_interval"</span>, <span class="st">"var"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>      ds_key, mdl_id, geom_id, val)</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>  d_spp <span class="ot">&lt;-</span> d_taxa <span class="sc">|&gt;</span> </span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(taxa_sci) <span class="sc">|&gt;</span></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>      <span class="at">taxa_common =</span> <span class="fu">first</span>(taxa_common) <span class="sc">|&gt;</span> <span class="fu">str_replace_all</span>(<span class="st">"Oceanic "</span>, <span class="st">""</span>) ) <span class="sc">|&gt;</span> </span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>      <span class="at">ds_key =</span> <span class="st">"gm"</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(ds_key, <span class="at">sp_key =</span> taxa_sci, <span class="at">sp_common =</span> taxa_common) <span class="sc">|&gt;</span> </span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>      <span class="at">sp_scientific =</span> sp_key)</span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>  t_spp <span class="ot">&lt;-</span> <span class="fu">Id</span>(<span class="at">schema =</span> schema, <span class="at">table =</span> <span class="st">"sdm_species"</span>)</span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>  rows_exist <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, t_spp) <span class="sc">|&gt;</span> <span class="fu">filter</span>(ds_key <span class="sc">==</span> <span class="st">"gm"</span>) <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">pull</span>() <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>rows_exist)</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dbWriteTable</span>(con, t_spp, d_spp, <span class="at">append =</span> T)</span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>  t_mdls <span class="ot">&lt;-</span> <span class="fu">Id</span>(<span class="at">schema =</span> schema, <span class="at">table =</span> <span class="st">"sdm_models"</span>)</span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>  rows_exist <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, t_mdls) <span class="sc">|&gt;</span> <span class="fu">filter</span>(ds_key <span class="sc">==</span> <span class="st">"gm"</span>) <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">pull</span>() <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>rows_exist)</span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dbWriteTable</span>(con, t_mdls, d_mdls, <span class="at">append =</span> T)</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>  <span class="co"># check: d_vals |&gt; select(mo, time_interval) |&gt; table()</span></span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbWriteTable</span>(con, t_vals, d_vals, <span class="at">append =</span> T)</span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>t_mdls <span class="ot">&lt;-</span> <span class="fu">Id</span>(<span class="at">schema =</span> schema, <span class="at">table =</span> <span class="st">"sdm_models"</span>)</span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a><span class="fu">tbl</span>(con, t_mdls) <span class="sc">|&gt;</span> </span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>description) <span class="sc">|&gt;</span> </span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span> </span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">

<div class="datatables html-widget html-fill-item" id="htmlwidget-de9f4deac7d17c58aeb8" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-de9f4deac7d17c58aeb8">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44","45","46","47","48","49","50","51","52","53","54","55","56","57","58","59","60","61","62","63","64","65","66","67","68","69","70","71","72","73","74","75","76","77","78","79","80","81","82","83","84","85","86","87","88","89","90","91","92","93","94","95","96","97","98","99","100","101","102","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118","119","120","121","122","123","124","125","126","127","128","129","130","131","132","133","134","135","136","137","138","139","140","141","142","143","144","145","146","147","148","149","150","151","152","153","154","155","156","157","158","159","160","161","162","163","164","165","166","167","168","169","170","171","172","173","174","175","176","177","178","179","180","181","182","183","184","185","186","187","188","189","190","191","192","193","194","195","196","197","198","199","200","201","202","203","204","205","206","207","208","209","210","211","212","213","214","215","216","217","218","219","220","221","222","223","224","225","226","227","228","229","230","231","232","233","234","235","236","237","238","239","240","241","242","243","244","245","246","247","248","249","250","251","252","253","254","255","256","257","258","259","260","261","262","263","264","265","266","267","268","269","270","271","272","273","274","275","276","277","278","279","280","281","282","283","284","285","286","287","288","289","290","291","292","293","294","295","296","297","298","299","300","301","302","303","304","305","306","307","308","309","310","311","312","313","314","315","316","317","318","319","320","321","322","323","324","325","326","327","328","329","330","331","332","333","334","335","336","337","338","339","340","341","342","343","344","345","346","347","348","349","350","351","352","353","354","355","356","357","358","359","360","361","362","363","364","365","366","367","368","369","370","371","372","373","374","375","376","377","378","379","380","381","382","383","384","385","386","387","388","389","390","391","392","393","394","395","396","397","398","399","400","401","402","403","404","405","406","407","408","409","410","411","412","413","414","415","416","417","418","419","420","421","422","423","424","425","426","427","428","429","430","431","432","433","434","435","436","437","438","439","440","441","442","443","444","445","446","447","448","449","450","451","452","453","454","455","456","457","458","459","460","461","462","463","464","465","466","467","468","469","470","471","472","473","474","475","476","477","478","479","480","481","482","483","484","485","486","487","488","489","490","491","492","493","494","495","496","497","498","499","500","501","502","503","504","505","506","507","508","509","510","511","512","513","514","515","516","517","518","519","520","521","522","523","524","525","526","527","528","529","530","531","532","533","534","535","536","537","538","539","540","541","542","543","544","545","546","547","548","549","550","551","552","553","554","555","556","557","558","559","560","561","562","563","564","565","566","567","568","569","570","571","572","573","574","575","576","577","578","579","580","581","582","583","584","585","586","587","588","589","590","591","592","593","594","595","596","597","598","599","600","601","602","603","604","605","606","607","608","609","610","611","612","613","614","615","616","617","618","619","620","621","622","623","624","625","626","627","628","629","630","631","632","633","634","635","636","637","638","639","640","641","642","643","644","645","646","647","648","649","650","651","652","653","654","655","656","657","658","659","660","661","662","663","664","665","666","667","668","669","670","671","672"],["gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm","gm"],[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,289,290,291,292,293,294,295,296,297,298,299,300,301,302,303,304,305,306,307,308,309,310,311,312,313,314,315,316,317,318,319,320,321,322,323,324,325,326,327,328,329,330,331,332,333,334,335,336,337,338,339,340,341,342,343,344,345,346,347,348,349,350,351,352,353,354,355,356,357,358,359,360,361,362,363,364,365,366,367,368,369,370,371,372,373,374,375,376,377,378,379,380,381,382,383,384,385,386,387,388,389,390,391,392,393,394,395,396,397,398,399,400,401,402,403,404,405,406,407,408,409,410,411,412,413,414,415,416,417,418,419,420,421,422,423,424,425,426,427,428,429,430,431,432,433,434,435,436,437,438,439,440,441,442,443,444,445,446,447,448,449,450,451,452,453,454,455,456,457,458,459,460,461,462,463,464,465,466,467,468,469,470,471,472,473,474,475,476,477,478,479,480,481,482,483,484,485,486,487,488,489,490,491,492,493,494,495,496,497,498,499,500,501,502,503,504,505,506,507,508,509,510,511,512,513,514,515,516,517,518,519,520,521,522,523,524,525,526,527,528,529,530,531,532,533,534,535,536,537,538,539,540,541,542,543,544,545,546,547,548,549,550,551,552,553,554,555,556,557,558,559,560,561,562,563,564,565,566,567,568,569,570,571,572,573,574,575,576,577,578,579,580,581,582,583,584,585,586,587,588,589,590,591,592,593,594,595,596,597,598,599,600,601,602,603,604,605,606,607,608,609,610,611,612,613,614,615,616,617,618,619,620,621,622,623,624,625,626,627,628,629,630,631,632,633,634,635,636,637,638,639,640,641,642,643,644,645,646,647,648,649,650,651,652,653,654,655,656,657,658,659,660,661,662,663,664,665,666,667,668,669,670,671,672],["Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Balaenoptera ricei","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Caretta caretta","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Chelonia mydas","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Delphinidae","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Dermochelys coriacea","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Globicephala","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Grampus griseus","Kogia","Kogia","Kogia","Kogia","Kogia","Kogia","Kogia","Kogia","Kogia","Kogia","Kogia","Kogia","Kogia","Kogia","Kogia","Kogia","Kogia","Kogia","Kogia","Kogia","Kogia","Kogia","Kogia","Kogia","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Lepidochelys kempii","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Physeter macrocephalus","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella attenuata","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella clymene","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella coeruleoalba","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella frontalis","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Stenella longirostris","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Tursiops truncatus","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius","Ziphius"],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,"Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf",null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,"Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Oceanic","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf","Shelf",null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],["2019-01/P1M","2019-01/P1M","2019-01/P1M","2019-02/P1M","2019-02/P1M","2019-02/P1M","2019-03/P1M","2019-03/P1M","2019-03/P1M","2019-04/P1M","2019-04/P1M","2019-04/P1M","2019-05/P1M","2019-05/P1M","2019-05/P1M","2019-06/P1M","2019-06/P1M","2019-06/P1M","2019-07/P1M","2019-07/P1M","2019-07/P1M","2019-08/P1M","2019-08/P1M","2019-08/P1M","2019-09/P1M","2019-09/P1M","2019-09/P1M","2019-10/P1M","2019-10/P1M","2019-10/P1M","2019-11/P1M","2019-11/P1M","2019-11/P1M","2019-12/P1M","2019-12/P1M","2019-12/P1M","2019-01/P1M","2019-01/P1M","2019-01/P1M","2019-02/P1M","2019-02/P1M","2019-02/P1M","2019-03/P1M","2019-03/P1M","2019-03/P1M","2019-04/P1M","2019-04/P1M","2019-04/P1M","2019-05/P1M","2019-05/P1M","2019-05/P1M","2019-06/P1M","2019-06/P1M","2019-06/P1M","2019-07/P1M","2019-07/P1M","2019-07/P1M","2019-08/P1M","2019-08/P1M","2019-08/P1M","2019-09/P1M","2019-09/P1M","2019-09/P1M","2019-10/P1M","2019-10/P1M","2019-10/P1M","2019-11/P1M","2019-11/P1M","2019-11/P1M","2019-12/P1M","2019-12/P1M","2019-12/P1M","2019-01/P1M","2019-01/P1M","2019-01/P1M","2019-02/P1M","2019-02/P1M","2019-02/P1M","2019-03/P1M","2019-03/P1M","2019-03/P1M","2019-04/P1M","2019-04/P1M","2019-04/P1M","2019-05/P1M","2019-05/P1M","2019-05/P1M","2019-06/P1M","2019-06/P1M","2019-06/P1M","2019-07/P1M","2019-07/P1M","2019-07/P1M","2019-08/P1M","2019-08/P1M","2019-08/P1M","2019-09/P1M","2019-09/P1M","2019-09/P1M","2019-10/P1M","2019-10/P1M","2019-10/P1M","2019-11/P1M","2019-11/P1M","2019-11/P1M","2019-12/P1M","2019-12/P1M","2019-12/P1M","2019-01/P1M","2019-01/P1M","2019-01/P1M","2019-02/P1M","2019-02/P1M","2019-02/P1M","2019-03/P1M","2019-03/P1M","2019-03/P1M","2019-04/P1M","2019-04/P1M","2019-04/P1M","2019-05/P1M","2019-05/P1M","2019-05/P1M","2019-06/P1M","2019-06/P1M","2019-06/P1M","2019-07/P1M","2019-07/P1M","2019-07/P1M","2019-08/P1M","2019-08/P1M","2019-08/P1M","2019-09/P1M","2019-09/P1M","2019-09/P1M","2019-10/P1M","2019-10/P1M","2019-10/P1M","2019-11/P1M","2019-11/P1M","2019-11/P1M","2019-12/P1M","2019-12/P1M","2019-12/P1M","2019-01/P1M","2019-01/P1M","2019-01/P1M","2019-02/P1M","2019-02/P1M","2019-02/P1M","2019-03/P1M","2019-03/P1M","2019-03/P1M","2019-04/P1M","2019-04/P1M","2019-04/P1M","2019-05/P1M","2019-05/P1M","2019-05/P1M","2019-06/P1M","2019-06/P1M","2019-06/P1M","2019-07/P1M","2019-07/P1M","2019-07/P1M","2019-08/P1M","2019-08/P1M","2019-08/P1M","2019-09/P1M","2019-09/P1M","2019-09/P1M","2019-10/P1M","2019-10/P1M","2019-10/P1M","2019-11/P1M","2019-11/P1M","2019-11/P1M","2019-12/P1M","2019-12/P1M","2019-12/P1M","2019-01/P1M","2019-01/P1M","2019-01/P1M","2019-02/P1M","2019-02/P1M","2019-02/P1M","2019-03/P1M","2019-03/P1M","2019-03/P1M","2019-04/P1M","2019-04/P1M","2019-04/P1M","2019-05/P1M","2019-05/P1M","2019-05/P1M","2019-06/P1M","2019-06/P1M","2019-06/P1M","2019-07/P1M","2019-07/P1M","2019-07/P1M","2019-08/P1M","2019-08/P1M","2019-08/P1M","2019-09/P1M","2019-09/P1M","2019-09/P1M","2019-10/P1M","2019-10/P1M","2019-10/P1M","2019-11/P1M","2019-11/P1M","2019-11/P1M","2019-12/P1M","2019-12/P1M","2019-12/P1M","2019-01/P1M","2019-01/P1M","2019-01/P1M","2019-02/P1M","2019-02/P1M","2019-02/P1M","2019-03/P1M","2019-03/P1M","2019-03/P1M","2019-04/P1M","2019-04/P1M","2019-04/P1M","2019-05/P1M","2019-05/P1M","2019-05/P1M","2019-06/P1M","2019-06/P1M","2019-06/P1M","2019-07/P1M","2019-07/P1M","2019-07/P1M","2019-08/P1M","2019-08/P1M","2019-08/P1M","2019-09/P1M","2019-09/P1M","2019-09/P1M","2019-10/P1M","2019-10/P1M","2019-10/P1M","2019-11/P1M","2019-11/P1M","2019-11/P1M","2019-12/P1M","2019-12/P1M","2019-12/P1M","2019-04/P1M","2019-04/P1M","2019-04/P1M","2019-05/P1M","2019-05/P1M","2019-05/P1M","2019-06/P1M","2019-06/P1M","2019-06/P1M","2019-07/P1M","2019-07/P1M","2019-07/P1M","2019-08/P1M","2019-08/P1M","2019-08/P1M","2019-09/P1M","2019-09/P1M","2019-09/P1M","2019-10/P1M","2019-10/P1M","2019-10/P1M","2019-11/P1M","2019-11/P1M","2019-11/P1M","2019-01/P1M","2019-01/P1M","2019-01/P1M","2019-02/P1M","2019-02/P1M","2019-02/P1M","2019-03/P1M","2019-03/P1M","2019-03/P1M","2019-04/P1M","2019-04/P1M","2019-04/P1M","2019-05/P1M","2019-05/P1M","2019-05/P1M","2019-06/P1M","2019-06/P1M","2019-06/P1M","2019-07/P1M","2019-07/P1M","2019-07/P1M","2019-08/P1M","2019-08/P1M","2019-08/P1M","2019-09/P1M","2019-09/P1M","2019-09/P1M","2019-10/P1M","2019-10/P1M","2019-10/P1M","2019-11/P1M","2019-11/P1M","2019-11/P1M","2019-12/P1M","2019-12/P1M","2019-12/P1M","2019-01/P1M","2019-01/P1M","2019-01/P1M","2019-02/P1M","2019-02/P1M","2019-02/P1M","2019-03/P1M","2019-03/P1M","2019-03/P1M","2019-04/P1M","2019-04/P1M","2019-04/P1M","2019-05/P1M","2019-05/P1M","2019-05/P1M","2019-06/P1M","2019-06/P1M","2019-06/P1M","2019-07/P1M","2019-07/P1M","2019-07/P1M","2019-08/P1M","2019-08/P1M","2019-08/P1M","2019-09/P1M","2019-09/P1M","2019-09/P1M","2019-10/P1M","2019-10/P1M","2019-10/P1M","2019-11/P1M","2019-11/P1M","2019-11/P1M","2019-12/P1M","2019-12/P1M","2019-12/P1M","2019-01/P1M","2019-01/P1M","2019-01/P1M","2019-02/P1M","2019-02/P1M","2019-02/P1M","2019-03/P1M","2019-03/P1M","2019-03/P1M","2019-04/P1M","2019-04/P1M","2019-04/P1M","2019-05/P1M","2019-05/P1M","2019-05/P1M","2019-06/P1M","2019-06/P1M","2019-06/P1M","2019-07/P1M","2019-07/P1M","2019-07/P1M","2019-08/P1M","2019-08/P1M","2019-08/P1M","2019-09/P1M","2019-09/P1M","2019-09/P1M","2019-10/P1M","2019-10/P1M","2019-10/P1M","2019-11/P1M","2019-11/P1M","2019-11/P1M","2019-12/P1M","2019-12/P1M","2019-12/P1M","2019-01/P1M","2019-01/P1M","2019-01/P1M","2019-02/P1M","2019-02/P1M","2019-02/P1M","2019-03/P1M","2019-03/P1M","2019-03/P1M","2019-04/P1M","2019-04/P1M","2019-04/P1M","2019-05/P1M","2019-05/P1M","2019-05/P1M","2019-06/P1M","2019-06/P1M","2019-06/P1M","2019-07/P1M","2019-07/P1M","2019-07/P1M","2019-08/P1M","2019-08/P1M","2019-08/P1M","2019-09/P1M","2019-09/P1M","2019-09/P1M","2019-10/P1M","2019-10/P1M","2019-10/P1M","2019-11/P1M","2019-11/P1M","2019-11/P1M","2019-12/P1M","2019-12/P1M","2019-12/P1M","2019-01/P1M","2019-01/P1M","2019-01/P1M","2019-02/P1M","2019-02/P1M","2019-02/P1M","2019-03/P1M","2019-03/P1M","2019-03/P1M","2019-04/P1M","2019-04/P1M","2019-04/P1M","2019-05/P1M","2019-05/P1M","2019-05/P1M","2019-06/P1M","2019-06/P1M","2019-06/P1M","2019-07/P1M","2019-07/P1M","2019-07/P1M","2019-08/P1M","2019-08/P1M","2019-08/P1M","2019-09/P1M","2019-09/P1M","2019-09/P1M","2019-10/P1M","2019-10/P1M","2019-10/P1M","2019-11/P1M","2019-11/P1M","2019-11/P1M","2019-12/P1M","2019-12/P1M","2019-12/P1M","2019-01/P1M","2019-01/P1M","2019-01/P1M","2019-02/P1M","2019-02/P1M","2019-02/P1M","2019-03/P1M","2019-03/P1M","2019-03/P1M","2019-04/P1M","2019-04/P1M","2019-04/P1M","2019-05/P1M","2019-05/P1M","2019-05/P1M","2019-06/P1M","2019-06/P1M","2019-06/P1M","2019-07/P1M","2019-07/P1M","2019-07/P1M","2019-08/P1M","2019-08/P1M","2019-08/P1M","2019-09/P1M","2019-09/P1M","2019-09/P1M","2019-10/P1M","2019-10/P1M","2019-10/P1M","2019-11/P1M","2019-11/P1M","2019-11/P1M","2019-12/P1M","2019-12/P1M","2019-12/P1M","2019-01/P1M","2019-01/P1M","2019-01/P1M","2019-02/P1M","2019-02/P1M","2019-02/P1M","2019-03/P1M","2019-03/P1M","2019-03/P1M","2019-04/P1M","2019-04/P1M","2019-04/P1M","2019-05/P1M","2019-05/P1M","2019-05/P1M","2019-06/P1M","2019-06/P1M","2019-06/P1M","2019-07/P1M","2019-07/P1M","2019-07/P1M","2019-08/P1M","2019-08/P1M","2019-08/P1M","2019-09/P1M","2019-09/P1M","2019-09/P1M","2019-10/P1M","2019-10/P1M","2019-10/P1M","2019-11/P1M","2019-11/P1M","2019-11/P1M","2019-12/P1M","2019-12/P1M","2019-12/P1M","2019-01/P1M","2019-01/P1M","2019-01/P1M","2019-02/P1M","2019-02/P1M","2019-02/P1M","2019-03/P1M","2019-03/P1M","2019-03/P1M","2019-04/P1M","2019-04/P1M","2019-04/P1M","2019-05/P1M","2019-05/P1M","2019-05/P1M","2019-06/P1M","2019-06/P1M","2019-06/P1M","2019-07/P1M","2019-07/P1M","2019-07/P1M","2019-08/P1M","2019-08/P1M","2019-08/P1M","2019-09/P1M","2019-09/P1M","2019-09/P1M","2019-10/P1M","2019-10/P1M","2019-10/P1M","2019-11/P1M","2019-11/P1M","2019-11/P1M","2019-12/P1M","2019-12/P1M","2019-12/P1M","2019-01/P1M","2019-01/P1M","2019-01/P1M","2019-02/P1M","2019-02/P1M","2019-02/P1M","2019-03/P1M","2019-03/P1M","2019-03/P1M","2019-04/P1M","2019-04/P1M","2019-04/P1M","2019-05/P1M","2019-05/P1M","2019-05/P1M","2019-06/P1M","2019-06/P1M","2019-06/P1M","2019-07/P1M","2019-07/P1M","2019-07/P1M","2019-08/P1M","2019-08/P1M","2019-08/P1M","2019-09/P1M","2019-09/P1M","2019-09/P1M","2019-10/P1M","2019-10/P1M","2019-10/P1M","2019-11/P1M","2019-11/P1M","2019-11/P1M","2019-12/P1M","2019-12/P1M","2019-12/P1M","2019-01/P1M","2019-01/P1M","2019-01/P1M","2019-02/P1M","2019-02/P1M","2019-02/P1M","2019-03/P1M","2019-03/P1M","2019-03/P1M","2019-04/P1M","2019-04/P1M","2019-04/P1M","2019-05/P1M","2019-05/P1M","2019-05/P1M","2019-06/P1M","2019-06/P1M","2019-06/P1M","2019-07/P1M","2019-07/P1M","2019-07/P1M","2019-08/P1M","2019-08/P1M","2019-08/P1M","2019-09/P1M","2019-09/P1M","2019-09/P1M","2019-10/P1M","2019-10/P1M","2019-10/P1M","2019-11/P1M","2019-11/P1M","2019-11/P1M","2019-12/P1M","2019-12/P1M","2019-12/P1M","2019-01/P1M","2019-01/P1M","2019-01/P1M","2019-02/P1M","2019-02/P1M","2019-02/P1M","2019-03/P1M","2019-03/P1M","2019-03/P1M","2019-04/P1M","2019-04/P1M","2019-04/P1M","2019-05/P1M","2019-05/P1M","2019-05/P1M","2019-06/P1M","2019-06/P1M","2019-06/P1M","2019-07/P1M","2019-07/P1M","2019-07/P1M","2019-08/P1M","2019-08/P1M","2019-08/P1M","2019-09/P1M","2019-09/P1M","2019-09/P1M","2019-10/P1M","2019-10/P1M","2019-10/P1M","2019-11/P1M","2019-11/P1M","2019-11/P1M","2019-12/P1M","2019-12/P1M","2019-12/P1M"],["cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se","cv","n","se"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>ds_key<\/th>\n      <th>mdl_id<\/th>\n      <th>sp_key<\/th>\n      <th>population<\/th>\n      <th>time_interval<\/th>\n      <th>var<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":2},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"ds_key","targets":1},{"name":"mdl_id","targets":2},{"name":"sp_key","targets":3},{"name":"population","targets":4},{"name":"time_interval","targets":5},{"name":"var","targets":6}],"order":[],"autoWidth":false,"orderClasses":false},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tbl</span>(con, t_vals) <span class="sc">|&gt;</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>() <span class="sc">|&gt;</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span> </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">ds_key</th>
<th style="text-align: right;">mdl_id</th>
<th style="text-align: right;">geom_id</th>
<th style="text-align: right;">val</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">gm</td>
<td style="text-align: right;">638</td>
<td style="text-align: right;">139788</td>
<td style="text-align: right;">0.0006198</td>
</tr>
<tr class="even">
<td style="text-align: left;">gm</td>
<td style="text-align: right;">639</td>
<td style="text-align: right;">139788</td>
<td style="text-align: right;">0.0011117</td>
</tr>
<tr class="odd">
<td style="text-align: left;">gm</td>
<td style="text-align: right;">637</td>
<td style="text-align: right;">139788</td>
<td style="text-align: right;">1.7935747</td>
</tr>
<tr class="even">
<td style="text-align: left;">gm</td>
<td style="text-align: right;">641</td>
<td style="text-align: right;">139788</td>
<td style="text-align: right;">0.0005822</td>
</tr>
<tr class="odd">
<td style="text-align: left;">gm</td>
<td style="text-align: right;">642</td>
<td style="text-align: right;">139788</td>
<td style="text-align: right;">0.0010737</td>
</tr>
<tr class="even">
<td style="text-align: left;">gm</td>
<td style="text-align: right;">640</td>
<td style="text-align: right;">139788</td>
<td style="text-align: right;">1.8442154</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The map output is too big, but the following runs in RStudio.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># build query</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># tbl(con, t_mdls) |&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   filter(</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     ds_key        == "gm",</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     # sp_key        == "Stenella frontalis",</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     # population    == "Oceanic",</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     sp_key        == "Balaenoptera ricei",</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     time_interval == "2019-01/P1M",</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     var           == "n") |&gt;</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co">#   select(ds_key, mdl_id) |&gt; </span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co">#   left_join(</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co">#     tbl(con, t_vals),</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co">#     by = c("ds_key", "mdl_id") ) |&gt;</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co">#   left_join(</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co">#     tbl(con, t_geoms),</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="co">#     by = c("ds_key", "geom_id")) |&gt; </span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="co">#   select(val, geom) |&gt; </span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="co">#   show_query() # explain()</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT v.val, g.geom</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="st">FROM (</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT ds_key, mdl_id</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM public.sdm_models</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="st">  WHERE</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="st">    ds_key        = 'gm'                 AND</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="st"> -- sp_key        = 'Stenella frontalis' AND</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a><span class="st"> -- population    = 'Oceanic'            AND</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="st">    sp_key        = 'Balaenoptera ricei' AND</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a><span class="st">    time_interval = '2019-01/P1M'     AND</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a><span class="st">    var           = 'n' ) AS m</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a><span class="st">LEFT JOIN public.sdm_values AS v ON (</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a><span class="st">  m.ds_key = v.ds_key AND</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a><span class="st">  m.mdl_id = v.mdl_id )</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a><span class="st">LEFT JOIN public.sdm_geometries AS g ON (</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a><span class="st">  m.ds_key  = g.ds_key AND</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a><span class="st">  v.geom_id = g.geom_id )"</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">st_read</span>(con, <span class="at">query =</span> q)</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a><span class="fu">mapView</span>(p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./figures/ingest_sdm-gm_mapview.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Screenshot of running above query in RStudio.</figcaption>
</figure>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>gm_models <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(mdl_id, taxa_sci, taxa_doc, months, n_months)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>mdl_hex <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    mdl_id, d_density) <span class="sc">%&gt;%</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(d_density)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>gm_model_hexagons <span class="ot">&lt;-</span> mdl_hex <span class="sc">%&gt;%</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(hexid, geom) <span class="sc">%&gt;%</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">.groups=</span><span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>()</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>gm_model_hexagon_densities<span class="ot">&lt;-</span> mdl_hex <span class="sc">%&gt;%</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(mdl_id, hexid, density) <span class="sc">%&gt;%</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(density))</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="co"># helper functions ----</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>get_annual_density <span class="ot">&lt;-</span> <span class="cf">function</span>(d_sf, <span class="at">i=</span><span class="dv">0</span>){</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># i = 12; d_sf &lt;- d$sf[[i]]</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"{i} of {nrow(d)} in get_annual_density() ~ {Sys.time()}"</span>))</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get geometries</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>  geoms <span class="ot">&lt;-</span> d_sf <span class="sc">%&gt;%</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="at">hexid =</span> HEXID, <span class="at">geom =</span> geometry)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get *_n abundance (#/40km2) per month and calculate annual average density (#/km2)</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>  mos_n <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{month.abb}_n"</span>)</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>  attrs <span class="ot">&lt;-</span> d_sf <span class="sc">%&gt;%</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="at">hexid =</span> HEXID, <span class="fu">any_of</span>(mos_n)) <span class="sc">%&gt;%</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="sc">-</span>hexid, <span class="at">names_to =</span> <span class="st">"mo_n"</span>, <span class="at">values_to =</span> <span class="st">"n"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(n <span class="sc">!=</span> <span class="sc">-</span><span class="dv">9999</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(hexid) <span class="sc">%&gt;%</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">n =</span> <span class="fu">mean</span>(n),</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">density =</span> n <span class="sc">/</span> <span class="dv">40</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(hexid, density) <span class="co"># individuals / km2</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># return geometries joined with summarized attributes</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>  d_sum <span class="ot">&lt;-</span> geoms <span class="sc">%&gt;%</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>      attrs, <span class="at">by =</span> <span class="st">"hexid"</span>)</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>  d_sum</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a><span class="co"># add aphia_id ----</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>gm_models <span class="ot">&lt;-</span> <span class="fu">wm_add_aphia_id</span>(gm_models, taxa_sci)</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">?: combine Oceanic_* &amp; Shelf_* for AtlanticSpotted_Dolphin + CommonBottlenose_Dolphin</span></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a><span class="co"># write to database ----</span></span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">oh_pg_con</span>()</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a><span class="fu">dbWriteTable</span>(con, <span class="st">"gm_models"</span>, gm_models, <span class="at">overwrite=</span>T)</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a><span class="fu">st_write</span>(gm_model_hexagons, con, <span class="st">"gm_model_hexagons"</span>, <span class="at">delete_layer=</span>T)</span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a><span class="fu">dbWriteTable</span>(con, <span class="st">"gm_model_hexagon_densities"</span>, gm_model_hexagon_densities, <span class="at">overwrite=</span>T)</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a><span class="fu">create_index</span>(con, <span class="st">"gm_models"</span>, <span class="st">"mdl_id"</span>, <span class="at">unique =</span> T)</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a><span class="fu">create_index</span>(con, <span class="st">"gm_model_hexagons"</span>, <span class="st">"hexid"</span>, <span class="at">unique =</span> T)</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a><span class="fu">create_index</span>(con, <span class="st">"gm_model_hexagon_densities"</span>, <span class="fu">c</span>(<span class="st">"mdl_id"</span>, <span class="st">"hexid"</span>), <span class="at">unique =</span> T)</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a><span class="co"># hexid x cell_id ----</span></span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a><span class="fu">tbl</span>(con, <span class="st">"gm_model_hexagons"</span>)</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>oh_cells_ply <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>  con,</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>  <span class="st">"WITH</span></span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a><span class="st">  c  AS (</span></span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT</span></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a><span class="st">      cell_id, geom</span></span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a><span class="st">    FROM oh_cells),</span></span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a><span class="st">  d AS (</span></span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT</span></span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a><span class="st">      hexid AS ply_id, ST_Transform(geom, 4326) AS geom</span></span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a><span class="st">    FROM gm_model_hexagons)</span></span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT DISTINCT ON (tbl, ply_id, cell_id)</span></span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a><span class="st">    'gm_model_hexagons' AS tbl,</span></span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a><span class="st">    d.ply_id,</span></span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a><span class="st">    c.cell_id</span></span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM c JOIN</span></span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a><span class="st">    d ON ST_Covers(d.geom, c.geom)"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>()</span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>oh_cells_ply</span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a><span class="fu">dbSendQuery</span>(con, <span class="st">"DELETE FROM oh_cells_ply WHERE tbl = 'gm_model_hexagons'"</span>)</span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a><span class="fu">dbAppendTable</span>(con, <span class="st">"oh_cells_ply"</span>, oh_cells_ply)</span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a><span class="co"># test model output ----</span></span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">oh_pg_con</span>()</span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a>r_d <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"gm_models"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(taxa_sci <span class="sc">==</span> <span class="st">"Ziphius"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tbl</span>(con, <span class="st">"gm_model_hexagon_densities"</span>),</span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"mdl_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tbl</span>(con, <span class="st">"oh_cells_ply"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(tbl <span class="sc">==</span> <span class="st">"gm_model_hexagons"</span>),</span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"hexid"</span> <span class="ot">=</span> <span class="st">"ply_id"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(cell_id, density) <span class="sc">%&gt;%</span></span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(            <span class="co"># 1,977,010 -&gt; 1,959,979</span></span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(cell_id),</span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(density)) <span class="sc">%&gt;%</span></span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">oh_rast</span>()</span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a>r[r_d<span class="sc">$</span>cell_id] <span class="ot">&lt;-</span> r_d<span class="sc">$</span>density</span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a>tmp_tif <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">".tif"</span>)</span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">trim</span>(r)</span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r)</span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a><span class="fu">mapView</span>(r, <span class="at">maxpixels=</span><span class="fu">ncell</span>(r))</span>
<span id="cb8-114"><a href="#cb8-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-115"><a href="#cb8-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-116"><a href="#cb8-116" aria-hidden="true" tabindex="-1"></a><span class="co"># redo rast ----</span></span>
<span id="cb8-117"><a href="#cb8-117" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb8-118"><a href="#cb8-118" aria-hidden="true" tabindex="-1"></a>  here, readr, terra)</span>
<span id="cb8-119"><a href="#cb8-119" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">readr.show_col_types =</span> F)</span>
<span id="cb8-120"><a href="#cb8-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-121"><a href="#cb8-121" aria-hidden="true" tabindex="-1"></a>dir_lyrs_tif <span class="ot">&lt;-</span> <span class="st">"/Users/bbest/My Drive/projects/offhab/data/derived/lyrs_tif"</span></span>
<span id="cb8-122"><a href="#cb8-122" aria-hidden="true" tabindex="-1"></a>lyrs_csv     <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data-raw/layers.csv"</span>)</span>
<span id="cb8-123"><a href="#cb8-123" aria-hidden="true" tabindex="-1"></a>ds_key       <span class="ot">&lt;-</span> <span class="st">"gm"</span></span>
<span id="cb8-124"><a href="#cb8-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-125"><a href="#cb8-125" aria-hidden="true" tabindex="-1"></a><span class="co"># match with aphia_id</span></span>
<span id="cb8-126"><a href="#cb8-126" aria-hidden="true" tabindex="-1"></a>D <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb8-127"><a href="#cb8-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb8-128"><a href="#cb8-128" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tbl</span>(con, <span class="st">"taxa"</span>) <span class="sc">|&gt;</span> <span class="co"># distinct(tbl) |&gt; pull(tbl)</span></span>
<span id="cb8-129"><a href="#cb8-129" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(tbl <span class="sc">==</span> <span class="st">"gm_models"</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-130"><a href="#cb8-130" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(</span>
<span id="cb8-131"><a href="#cb8-131" aria-hidden="true" tabindex="-1"></a>        <span class="at">taxa_sci =</span> taxa,</span>
<span id="cb8-132"><a href="#cb8-132" aria-hidden="true" tabindex="-1"></a>        aphia_id) <span class="sc">|&gt;</span></span>
<span id="cb8-133"><a href="#cb8-133" aria-hidden="true" tabindex="-1"></a>      <span class="fu">collect</span>(),</span>
<span id="cb8-134"><a href="#cb8-134" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"taxa_sci"</span>)</span>
<span id="cb8-135"><a href="#cb8-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-136"><a href="#cb8-136" aria-hidden="true" tabindex="-1"></a><span class="co"># combine:</span></span>
<span id="cb8-137"><a href="#cb8-137" aria-hidden="true" tabindex="-1"></a><span class="co">#           Stenella frontalis | Tursiops truncatus</span></span>
<span id="cb8-138"><a href="#cb8-138" aria-hidden="true" tabindex="-1"></a><span class="co">#  oceanic |                 8 |                  9</span></span>
<span id="cb8-139"><a href="#cb8-139" aria-hidden="true" tabindex="-1"></a><span class="co">#    shelf |                15 |                 16</span></span>
<span id="cb8-140"><a href="#cb8-140" aria-hidden="true" tabindex="-1"></a>d_sf <span class="ot">&lt;-</span> D <span class="sc">|&gt;</span></span>
<span id="cb8-141"><a href="#cb8-141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb8-142"><a href="#cb8-142" aria-hidden="true" tabindex="-1"></a>    mdl_id <span class="sc">==</span> <span class="dv">8</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-143"><a href="#cb8-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(aphia_id, d_density) <span class="sc">|&gt;</span></span>
<span id="cb8-144"><a href="#cb8-144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(d_density) <span class="sc">|&gt;</span></span>
<span id="cb8-145"><a href="#cb8-145" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">density_oceanic =</span> density) <span class="sc">|&gt;</span></span>
<span id="cb8-146"><a href="#cb8-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb8-147"><a href="#cb8-147" aria-hidden="true" tabindex="-1"></a>    D <span class="sc">|&gt;</span></span>
<span id="cb8-148"><a href="#cb8-148" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(</span>
<span id="cb8-149"><a href="#cb8-149" aria-hidden="true" tabindex="-1"></a>        mdl_id <span class="sc">==</span> <span class="dv">15</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-150"><a href="#cb8-150" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(mdl_id, d_density) <span class="sc">|&gt;</span></span>
<span id="cb8-151"><a href="#cb8-151" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unnest</span>(d_density) <span class="sc">|&gt;</span></span>
<span id="cb8-152"><a href="#cb8-152" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(</span>
<span id="cb8-153"><a href="#cb8-153" aria-hidden="true" tabindex="-1"></a>        hexid, <span class="at">density_shelf =</span> density),</span>
<span id="cb8-154"><a href="#cb8-154" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"hexid"</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-155"><a href="#cb8-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-156"><a href="#cb8-156" aria-hidden="true" tabindex="-1"></a>    <span class="at">density =</span> <span class="fu">map2_dbl</span>(</span>
<span id="cb8-157"><a href="#cb8-157" aria-hidden="true" tabindex="-1"></a>      density_oceanic, density_shelf, sum, <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span></span>
<span id="cb8-158"><a href="#cb8-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>density_oceanic, <span class="sc">-</span>density_shelf) <span class="sc">|&gt;</span></span>
<span id="cb8-159"><a href="#cb8-159" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>(</span>
<span id="cb8-160"><a href="#cb8-160" aria-hidden="true" tabindex="-1"></a>    <span class="at">d_density =</span> <span class="fu">c</span>(hexid, geom, density))</span>
<span id="cb8-161"><a href="#cb8-161" aria-hidden="true" tabindex="-1"></a>d_tt <span class="ot">&lt;-</span> D <span class="sc">|&gt;</span></span>
<span id="cb8-162"><a href="#cb8-162" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb8-163"><a href="#cb8-163" aria-hidden="true" tabindex="-1"></a>    mdl_id <span class="sc">==</span> <span class="dv">9</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-164"><a href="#cb8-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(aphia_id, d_density) <span class="sc">|&gt;</span></span>
<span id="cb8-165"><a href="#cb8-165" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(d_density) <span class="sc">|&gt;</span></span>
<span id="cb8-166"><a href="#cb8-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">density_oceanic =</span> density) <span class="sc">|&gt;</span></span>
<span id="cb8-167"><a href="#cb8-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb8-168"><a href="#cb8-168" aria-hidden="true" tabindex="-1"></a>    D <span class="sc">|&gt;</span></span>
<span id="cb8-169"><a href="#cb8-169" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(</span>
<span id="cb8-170"><a href="#cb8-170" aria-hidden="true" tabindex="-1"></a>        mdl_id <span class="sc">==</span> <span class="dv">16</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-171"><a href="#cb8-171" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(mdl_id, d_density) <span class="sc">|&gt;</span></span>
<span id="cb8-172"><a href="#cb8-172" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unnest</span>(d_density) <span class="sc">|&gt;</span></span>
<span id="cb8-173"><a href="#cb8-173" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(</span>
<span id="cb8-174"><a href="#cb8-174" aria-hidden="true" tabindex="-1"></a>        hexid, <span class="at">density_shelf =</span> density),</span>
<span id="cb8-175"><a href="#cb8-175" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"hexid"</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-176"><a href="#cb8-176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-177"><a href="#cb8-177" aria-hidden="true" tabindex="-1"></a>    <span class="at">density =</span> <span class="fu">map2_dbl</span>(</span>
<span id="cb8-178"><a href="#cb8-178" aria-hidden="true" tabindex="-1"></a>      density_oceanic, density_shelf, sum, <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span></span>
<span id="cb8-179"><a href="#cb8-179" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>density_oceanic, <span class="sc">-</span>density_shelf) <span class="sc">|&gt;</span></span>
<span id="cb8-180"><a href="#cb8-180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>(</span>
<span id="cb8-181"><a href="#cb8-181" aria-hidden="true" tabindex="-1"></a>    <span class="at">d_density =</span> <span class="fu">c</span>(hexid, geom, density))</span>
<span id="cb8-182"><a href="#cb8-182" aria-hidden="true" tabindex="-1"></a>D <span class="ot">&lt;-</span> D <span class="sc">|&gt;</span></span>
<span id="cb8-183"><a href="#cb8-183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>mdl_id <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">8</span>,<span class="dv">9</span>,<span class="dv">15</span>,<span class="dv">16</span>)) <span class="sc">|&gt;</span></span>
<span id="cb8-184"><a href="#cb8-184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(aphia_id, d_density) <span class="sc">|&gt;</span></span>
<span id="cb8-185"><a href="#cb8-185" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbind</span>(</span>
<span id="cb8-186"><a href="#cb8-186" aria-hidden="true" tabindex="-1"></a>    d_sf,</span>
<span id="cb8-187"><a href="#cb8-187" aria-hidden="true" tabindex="-1"></a>    d_tt)</span>
<span id="cb8-188"><a href="#cb8-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-189"><a href="#cb8-189" aria-hidden="true" tabindex="-1"></a><span class="co"># iterate over rasters</span></span>
<span id="cb8-190"><a href="#cb8-190" aria-hidden="true" tabindex="-1"></a>r_na <span class="ot">&lt;-</span> <span class="fu">oh_rast</span>(<span class="st">"NA"</span>)</span>
<span id="cb8-191"><a href="#cb8-191" aria-hidden="true" tabindex="-1"></a><span class="co"># for (i in 1:nrow(D)){ # i = 1</span></span>
<span id="cb8-192"><a href="#cb8-192" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">16</span><span class="sc">:</span><span class="fu">nrow</span>(D)){ <span class="co"># i = 16</span></span>
<span id="cb8-193"><a href="#cb8-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-194"><a href="#cb8-194" aria-hidden="true" tabindex="-1"></a>  aphia_id <span class="ot">&lt;-</span> D<span class="sc">$</span>aphia_id[i]</span>
<span id="cb8-195"><a href="#cb8-195" aria-hidden="true" tabindex="-1"></a>  lyr_key <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{ds_key}_{aphia_id}"</span>)</span>
<span id="cb8-196"><a href="#cb8-196" aria-hidden="true" tabindex="-1"></a>  r_tif <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{dir_lyrs_tif}/{lyr_key}.tif"</span>)</span>
<span id="cb8-197"><a href="#cb8-197" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"{i} of {nrow(D)}: {basename(r_tif)} ~ {Sys.time()}"</span>))</span>
<span id="cb8-198"><a href="#cb8-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-199"><a href="#cb8-199" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get density, geom</span></span>
<span id="cb8-200"><a href="#cb8-200" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> D <span class="sc">|&gt;</span></span>
<span id="cb8-201"><a href="#cb8-201" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(i) <span class="sc">|&gt;</span></span>
<span id="cb8-202"><a href="#cb8-202" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(d_density) <span class="sc">%&gt;%</span></span>
<span id="cb8-203"><a href="#cb8-203" aria-hidden="true" tabindex="-1"></a>    .[[<span class="dv">1</span>]] <span class="sc">|&gt;</span></span>
<span id="cb8-204"><a href="#cb8-204" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_as_sf</span>()</span>
<span id="cb8-205"><a href="#cb8-205" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mapView(d, zcol = "density")</span></span>
<span id="cb8-206"><a href="#cb8-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-207"><a href="#cb8-207" aria-hidden="true" tabindex="-1"></a>  <span class="co"># convert to raster</span></span>
<span id="cb8-208"><a href="#cb8-208" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb8-209"><a href="#cb8-209" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="dv">3857</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-210"><a href="#cb8-210" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rasterize</span>(</span>
<span id="cb8-211"><a href="#cb8-211" aria-hidden="true" tabindex="-1"></a>      r_na, <span class="st">"density"</span>)</span>
<span id="cb8-212"><a href="#cb8-212" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plet(r, tiles="Esri.NatGeoWorldMap")</span></span>
<span id="cb8-213"><a href="#cb8-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-214"><a href="#cb8-214" aria-hidden="true" tabindex="-1"></a>  <span class="co"># rescale 0 to 100; set 0 -&gt; NA</span></span>
<span id="cb8-215"><a href="#cb8-215" aria-hidden="true" tabindex="-1"></a>  (vr <span class="ot">&lt;-</span> <span class="fu">range</span>(<span class="fu">values</span>(r, <span class="at">na.rm =</span> T)))</span>
<span id="cb8-216"><a href="#cb8-216" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> <span class="fu">setValues</span>(</span>
<span id="cb8-217"><a href="#cb8-217" aria-hidden="true" tabindex="-1"></a>    r,</span>
<span id="cb8-218"><a href="#cb8-218" aria-hidden="true" tabindex="-1"></a>    scales<span class="sc">::</span><span class="fu">rescale</span>(</span>
<span id="cb8-219"><a href="#cb8-219" aria-hidden="true" tabindex="-1"></a>      <span class="fu">values</span>(r),</span>
<span id="cb8-220"><a href="#cb8-220" aria-hidden="true" tabindex="-1"></a>      <span class="at">to =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">100</span>)) )</span>
<span id="cb8-221"><a href="#cb8-221" aria-hidden="true" tabindex="-1"></a>  r[r<span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb8-222"><a href="#cb8-222" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plet(r, tiles="Esri.NatGeoWorldMap")</span></span>
<span id="cb8-223"><a href="#cb8-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-224"><a href="#cb8-224" aria-hidden="true" tabindex="-1"></a>  <span class="co"># write raster</span></span>
<span id="cb8-225"><a href="#cb8-225" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_rast</span>(r, r_tif)</span>
<span id="cb8-226"><a href="#cb8-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-227"><a href="#cb8-227" aria-hidden="true" tabindex="-1"></a>  <span class="co"># write min, max to layers.csv</span></span>
<span id="cb8-228"><a href="#cb8-228" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(lyrs_csv) <span class="sc">|&gt;</span></span>
<span id="cb8-229"><a href="#cb8-229" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(</span>
<span id="cb8-230"><a href="#cb8-230" aria-hidden="true" tabindex="-1"></a>      lyr_key <span class="sc">!=</span> <span class="sc">!!</span>lyr_key) <span class="sc">|&gt;</span></span>
<span id="cb8-231"><a href="#cb8-231" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(</span>
<span id="cb8-232"><a href="#cb8-232" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tibble</span>(</span>
<span id="cb8-233"><a href="#cb8-233" aria-hidden="true" tabindex="-1"></a>        <span class="at">lyr_key     =</span> lyr_key,</span>
<span id="cb8-234"><a href="#cb8-234" aria-hidden="true" tabindex="-1"></a>        <span class="at">ds_key      =</span> ds_key,</span>
<span id="cb8-235"><a href="#cb8-235" aria-hidden="true" tabindex="-1"></a>        <span class="at">aphia_id    =</span> aphia_id,</span>
<span id="cb8-236"><a href="#cb8-236" aria-hidden="true" tabindex="-1"></a>        <span class="at">val_min     =</span> vr[<span class="dv">1</span>],</span>
<span id="cb8-237"><a href="#cb8-237" aria-hidden="true" tabindex="-1"></a>        <span class="at">val_max     =</span> vr[<span class="dv">2</span>],</span>
<span id="cb8-238"><a href="#cb8-238" aria-hidden="true" tabindex="-1"></a>        <span class="at">rescale_min =</span> <span class="dv">0</span>,</span>
<span id="cb8-239"><a href="#cb8-239" aria-hidden="true" tabindex="-1"></a>        <span class="at">rescale_max =</span> <span class="dv">100</span>) )</span>
<span id="cb8-240"><a href="#cb8-240" aria-hidden="true" tabindex="-1"></a>  <span class="co"># message(glue("  nrow(lyrs_csv): {nrow(d)}"))</span></span>
<span id="cb8-241"><a href="#cb8-241" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(d, lyrs_csv)</span>
<span id="cb8-242"><a href="#cb8-242" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<!-- -->


</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb9" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "GoMex cetacean &amp; sea turtle SDMs"</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="an">editor_options:</span><span class="co"> </span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">  chunk_output_type: console</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Cetacean and sea turtle spatial density model outputs from visual observations using line-transect survey methods aboard NOAA vessel and aircraft platforms in the Gulf of Mexico from 2003-06-12 to 2019-07-31 (NCEI Accession 0256800)</span><span class="co">](https://www.ncei.noaa.gov/access/metadata/landing-page/bin/iso?id=gov.noaa.nodc:256800)</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>additional <span class="co">[</span><span class="ot">metadata</span><span class="co">](https://www.fisheries.noaa.gov/inport/item/67830)</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="co">#| messages: FALSE</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: FALSE</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="co"># packages</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  devtools, dplyr, DT, fs, glue, here, janitor, knitr, mapview, purrr, readr, </span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>  readxl, sf, stringr, tibble, tidyr, units,</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">quiet =</span> T)</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">readr.show_col_types =</span> F)</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">here</span>(<span class="st">"libs/db.R"</span>)) <span class="co"># con</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>create_index <span class="ot">&lt;-</span> <span class="cf">function</span>(con, tbl, flds, <span class="at">schema =</span> <span class="st">"public"</span>, <span class="at">geom=</span>F, <span class="at">unique=</span>F, <span class="at">overwrite=</span>F, <span class="at">show=</span>F, <span class="at">exec=</span>T){</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># tbl = "taxa"; flds = c("tbl_orig", "aphia_id"); unique = T; geom=F</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stopifnot</span>(<span class="sc">!</span>(geom <span class="sc">==</span> T <span class="sc">&amp;</span> <span class="fu">length</span>(flds) <span class="sc">!=</span> <span class="dv">1</span>))</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>  sfx <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    geom,</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">" USING GIST ({flds})"</span>),</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>    glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"({paste(flds, collapse=', ')})"</span>))</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>    unique,</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">glue</span>(<span class="st">"{tbl}_unique_idx"</span>),</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">glue</span>(<span class="st">"{tbl}_{paste(flds, collapse='_')}_idx"</span>))</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (overwrite)</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dbExecute</span>(con, <span class="fu">glue</span>(<span class="st">"DROP INDEX IF EXISTS {schema}.{idx}"</span>))</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>  sql <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">"CREATE {ifelse(unique, 'UNIQUE','')} INDEX IF NOT EXISTS {idx} ON {schema}.{tbl}{sfx}"</span>)</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (show)</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(sql)</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (exec)</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dbExecute</span>(con, sql)</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a><span class="in">```{r d_datasets}</span></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>schema <span class="ot">&lt;-</span> <span class="st">"public"</span></span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>d_datasets <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">ds_key      =</span> <span class="st">"gm"</span>,</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>  <span class="at">name_short  =</span> <span class="st">"NOAA GoMex Cetacean &amp; Sea Turtle Densities"</span>, <span class="co"># short name in form of {source_broad} {regions} {taxa_groups} {response_type}</span></span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>  <span class="at">name_full   =</span> <span class="st">"Cetacean and sea turtle spatial density model outputs from visual observations using line-transect survey methods aboard NOAA vessel and aircraft platforms in the Gulf of Mexico from 2003-06-12 to 2019-07-31 (NCEI Accession 0256800)"</span>,</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>  <span class="at">link        =</span> <span class="st">"https://www.ncei.noaa.gov/access/metadata/landing-page/bin/iso?id=gov.noaa.nodc:256800"</span>,</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>  <span class="at">citation    =</span> <span class="st">"Litz, Jenny; Aichinger Dias, Laura; Rappucci, Gina; Martinez, Anthony; Soldevilla, Melissa; Garrison, Lance; Mullin, Keith; Barry, Kevin; Foster, Marjorie (2022). Cetacean and sea turtle spatial density model outputs from visual observations using line-transect survey methods aboard NOAA vessel and aircraft platforms in the Gulf of Mexico from 2003-06-12 to 2019-07-31 (NCEI Accession 0256800). [indicate subset used]. NOAA National Centers for Environmental Information. Dataset. https://doi.org/10.25921/efv4-9z56. Accessed July 28, 2022."</span>,</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>  <span class="at">description =</span> <span class="st">"Based on ship-based and aerial line-transect surveys conducted in the U.S. waters of the Gulf of Mexico between 2003 and 2019, the NOAA Southeast Fisheries Science Center (SEFSC) developed spatial density models (SDMs) for cetacean and sea turtle species for the entire Gulf of Mexico. SDMs were developed using a generalized additive modeling (GAM) framework to determine the relationship between species abundance and environmental variables (monthly averaged oceanographic conditions during 2015 - 2019). Models were extrapolated beyond the U.S. Gulf of Mexico to provide insight into potential high density areas throughout the Gulf of Mexico. However, extrapolations of this type should be interpreted with caution. This dataset includes 19 shapefiles for the SDMs for each cetacean and sea turtle species or species group."</span>,</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>  <span class="at">response_type  =</span> <span class="st">"density"</span>,             </span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>  <span class="co"># response_type: one of: occurrence, range, suitability, probability or density</span></span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>  <span class="at">taxa_groups     =</span> <span class="st">"cetacean, sea turtle"</span>, </span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>  <span class="co"># taxa_groups: one or more of: fish, invertebrates, marine mammals, cetaceans, sea turtles, seabirds, etc.</span></span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>  <span class="at">year_pub       =</span> <span class="dv">2022</span>,</span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>  <span class="at">date_obs_beg   =</span> <span class="st">"2003-06-12"</span>, </span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>  <span class="at">date_obs_end   =</span> <span class="st">"2019-08-01"</span>,            <span class="co"># up to, but not including *_end</span></span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>  <span class="at">date_env_beg   =</span> <span class="st">"2015-01-01"</span>, </span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>  <span class="at">date_env_end   =</span> <span class="st">"2020-01-01"</span>,            <span class="co"># up to, but not including *_end</span></span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>  <span class="at">regions        =</span> <span class="fu">list</span>(<span class="st">"Gulf of Mexico"</span>))  <span class="co"># array</span></span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a><span class="co"># names(d_dataset) |&gt; paste(collapse = ", ") |&gt; cat()</span></span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>t_datasets <span class="ot">&lt;-</span> <span class="fu">Id</span>(<span class="at">schema =</span> schema, <span class="at">table =</span> <span class="st">"sdm_datasets"</span>)</span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>row_exists <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, t_datasets) <span class="sc">|&gt;</span> <span class="fu">filter</span>(ds_key <span class="sc">==</span> <span class="st">"gm"</span>) <span class="sc">|&gt;</span> <span class="fu">collect</span>() <span class="sc">|&gt;</span> <span class="fu">nrow</span>() <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>row_exists){</span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>  <span class="co"># append, except array columns: regions</span></span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbWriteTable</span>(</span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>    con, t_datasets, <span class="at">append =</span> T,</span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a>    d_datasets <span class="sc">|&gt;</span> </span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(<span class="sc">-</span>regions) )</span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a>  <span class="co"># append array column: regions</span></span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a>  regions_sql <span class="ot">&lt;-</span> <span class="fu">glue</span>(</span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ARRAY['{d_datasets$regions |&gt; unlist() |&gt; paste(collapse = ', ')}']"</span>)</span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbExecute</span>(</span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a>    con, </span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">glue</span>(</span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a>      <span class="st">"UPDATE sdm_datasets </span></span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a><span class="st">      SET   regions = {regions_sql}</span></span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a><span class="st">      WHERE ds_key  = 'gm'"</span>) )</span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a><span class="fu">tbl</span>(con, t_datasets) <span class="sc">|&gt;</span> </span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ds_key <span class="sc">==</span> <span class="st">"gm"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span></span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a><span class="in">```{r d_geoms}</span></span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a><span class="co"># helper functions ----</span></span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a>get_annual_density <span class="ot">&lt;-</span> <span class="cf">function</span>(d_sf, <span class="at">i=</span><span class="dv">0</span>){</span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a>  <span class="co"># i = 12; d_sf &lt;- d$sf[[i]]</span></span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"{i} of {nrow(d_sf)} in get_annual_density() ~ {Sys.time()}"</span>))</span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get geometries</span></span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true" tabindex="-1"></a>  geoms <span class="ot">&lt;-</span> d_sf <span class="sc">%&gt;%</span></span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="at">hexid =</span> HEXID, <span class="at">geom =</span> geometry)</span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get *_n abundance (#/40km2) per month and calculate annual average density (#/km2)</span></span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a>  mos_n <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{month.abb}_n"</span>)</span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true" tabindex="-1"></a>  attrs <span class="ot">&lt;-</span> d_sf <span class="sc">%&gt;%</span></span>
<span id="cb9-117"><a href="#cb9-117" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb9-118"><a href="#cb9-118" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="at">hexid =</span> HEXID, <span class="fu">any_of</span>(mos_n)) <span class="sc">%&gt;%</span></span>
<span id="cb9-119"><a href="#cb9-119" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="sc">-</span>hexid, <span class="at">names_to =</span> <span class="st">"mo_n"</span>, <span class="at">values_to =</span> <span class="st">"n"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-120"><a href="#cb9-120" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(n <span class="sc">!=</span> <span class="sc">-</span><span class="dv">9999</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-121"><a href="#cb9-121" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(hexid) <span class="sc">%&gt;%</span></span>
<span id="cb9-122"><a href="#cb9-122" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(</span>
<span id="cb9-123"><a href="#cb9-123" aria-hidden="true" tabindex="-1"></a>      <span class="at">n =</span> <span class="fu">mean</span>(n),</span>
<span id="cb9-124"><a href="#cb9-124" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-125"><a href="#cb9-125" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb9-126"><a href="#cb9-126" aria-hidden="true" tabindex="-1"></a>      <span class="at">density =</span> n <span class="sc">/</span> <span class="dv">40</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-127"><a href="#cb9-127" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(hexid, density) <span class="co"># individuals / km2</span></span>
<span id="cb9-128"><a href="#cb9-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-129"><a href="#cb9-129" aria-hidden="true" tabindex="-1"></a>  <span class="co"># return geometries joined with summarized attributes</span></span>
<span id="cb9-130"><a href="#cb9-130" aria-hidden="true" tabindex="-1"></a>  d_sum <span class="ot">&lt;-</span> geoms <span class="sc">%&gt;%</span></span>
<span id="cb9-131"><a href="#cb9-131" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(</span>
<span id="cb9-132"><a href="#cb9-132" aria-hidden="true" tabindex="-1"></a>      attrs, <span class="at">by =</span> <span class="st">"hexid"</span>)</span>
<span id="cb9-133"><a href="#cb9-133" aria-hidden="true" tabindex="-1"></a>  d_sum</span>
<span id="cb9-134"><a href="#cb9-134" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-135"><a href="#cb9-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-136"><a href="#cb9-136" aria-hidden="true" tabindex="-1"></a><span class="co"># read layers ----</span></span>
<span id="cb9-137"><a href="#cb9-137" aria-hidden="true" tabindex="-1"></a>dir_shp   <span class="ot">&lt;-</span> <span class="st">"/Users/bbest/My Drive/projects/offhab/data/raw/ncei.noaa.gov - GoMex cetacean &amp; sea turtle SDMs/0256800/2.2/data/0-data/NOAA_SEFSC_Cetacean_SeaTurtle_SDM_shapefiles"</span></span>
<span id="cb9-138"><a href="#cb9-138" aria-hidden="true" tabindex="-1"></a>taxa_xls <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{dir_shp}/../spp_gmx.xlsx"</span>)</span>
<span id="cb9-139"><a href="#cb9-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-140"><a href="#cb9-140" aria-hidden="true" tabindex="-1"></a>d_taxa <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(taxa_xls)</span>
<span id="cb9-141"><a href="#cb9-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-142"><a href="#cb9-142" aria-hidden="true" tabindex="-1"></a>t_geoms <span class="ot">&lt;-</span> <span class="fu">Id</span>(<span class="at">schema =</span> schema, <span class="at">table =</span> <span class="st">"sdm_geometries"</span>)</span>
<span id="cb9-143"><a href="#cb9-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-144"><a href="#cb9-144" aria-hidden="true" tabindex="-1"></a>rows_exist <span class="ot">&lt;-</span> (</span>
<span id="cb9-145"><a href="#cb9-145" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl</span>(con, t_geoms) <span class="sc">|&gt;</span> </span>
<span id="cb9-146"><a href="#cb9-146" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(ds_key <span class="sc">==</span> <span class="st">"gm"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-147"><a href="#cb9-147" aria-hidden="true" tabindex="-1"></a>    <span class="fu">collect</span>() <span class="sc">|&gt;</span> </span>
<span id="cb9-148"><a href="#cb9-148" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nrow</span>() ) <span class="sc">&gt;</span> <span class="dv">1</span></span>
<span id="cb9-149"><a href="#cb9-149" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>rows_exist){</span>
<span id="cb9-150"><a href="#cb9-150" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb9-151"><a href="#cb9-151" aria-hidden="true" tabindex="-1"></a>    <span class="at">path_shp =</span> <span class="fu">list.files</span>(dir_shp, <span class="st">"shp$"</span>, <span class="at">full.names=</span>T)) <span class="sc">|&gt;</span> </span>
<span id="cb9-152"><a href="#cb9-152" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb9-153"><a href="#cb9-153" aria-hidden="true" tabindex="-1"></a>      <span class="at">base_shp =</span> <span class="fu">basename</span>(path_shp) <span class="sc">|&gt;</span> <span class="fu">path_ext_remove</span>(),</span>
<span id="cb9-154"><a href="#cb9-154" aria-hidden="true" tabindex="-1"></a>      <span class="at">taxa_shp =</span> <span class="fu">str_replace</span>(base_shp, <span class="st">"(.*)_Monthly_.*"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb9-155"><a href="#cb9-155" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(</span>
<span id="cb9-156"><a href="#cb9-156" aria-hidden="true" tabindex="-1"></a>      d_taxa  <span class="sc">|&gt;</span> </span>
<span id="cb9-157"><a href="#cb9-157" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(taxa_shp, taxa_sci, taxa_doc),</span>
<span id="cb9-158"><a href="#cb9-158" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="st">"taxa_shp"</span>)  <span class="sc">|&gt;</span> </span>
<span id="cb9-159"><a href="#cb9-159" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb9-160"><a href="#cb9-160" aria-hidden="true" tabindex="-1"></a>      <span class="at">population =</span> <span class="fu">map_chr</span>(</span>
<span id="cb9-161"><a href="#cb9-161" aria-hidden="true" tabindex="-1"></a>        base_shp, <span class="sc">~</span>{</span>
<span id="cb9-162"><a href="#cb9-162" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (<span class="fu">str_detect</span>(.x, <span class="st">"^(Oceanic)|(Shelf)"</span>)) {</span>
<span id="cb9-163"><a href="#cb9-163" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(<span class="fu">str_replace</span>(.x, <span class="st">"^(Oceanic|Shelf)_(.*)"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>))</span>
<span id="cb9-164"><a href="#cb9-164" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> {</span>
<span id="cb9-165"><a href="#cb9-165" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(<span class="cn">NA</span>)</span>
<span id="cb9-166"><a href="#cb9-166" aria-hidden="true" tabindex="-1"></a>          } }),</span>
<span id="cb9-167"><a href="#cb9-167" aria-hidden="true" tabindex="-1"></a>      <span class="at">sf         =</span> <span class="fu">map</span>(path_shp, read_sf),</span>
<span id="cb9-168"><a href="#cb9-168" aria-hidden="true" tabindex="-1"></a>      <span class="at">d_density  =</span> <span class="fu">imap</span>(sf, get_annual_density),</span>
<span id="cb9-169"><a href="#cb9-169" aria-hidden="true" tabindex="-1"></a>      <span class="at">months_lst =</span> <span class="fu">map</span>(sf, <span class="sc">~</span>{</span>
<span id="cb9-170"><a href="#cb9-170" aria-hidden="true" tabindex="-1"></a>        <span class="fu">intersect</span>(</span>
<span id="cb9-171"><a href="#cb9-171" aria-hidden="true" tabindex="-1"></a>          <span class="fu">colnames</span>(.),</span>
<span id="cb9-172"><a href="#cb9-172" aria-hidden="true" tabindex="-1"></a>          <span class="fu">glue</span>(<span class="st">"{month.abb}_n"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb9-173"><a href="#cb9-173" aria-hidden="true" tabindex="-1"></a>          <span class="fu">str_replace</span>(<span class="st">"_n"</span>, <span class="st">""</span>)  }),</span>
<span id="cb9-174"><a href="#cb9-174" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_months =</span> <span class="fu">map_int</span>(months_lst, length),</span>
<span id="cb9-175"><a href="#cb9-175" aria-hidden="true" tabindex="-1"></a>      <span class="at">months   =</span> <span class="fu">map_chr</span>(months_lst, paste, <span class="at">collapse=</span><span class="st">";"</span>) )</span>
<span id="cb9-176"><a href="#cb9-176" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-177"><a href="#cb9-177" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get unique geometries</span></span>
<span id="cb9-178"><a href="#cb9-178" aria-hidden="true" tabindex="-1"></a>  d_geoms <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb9-179"><a href="#cb9-179" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(sf) <span class="sc">|&gt;</span> </span>
<span id="cb9-180"><a href="#cb9-180" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb9-181"><a href="#cb9-181" aria-hidden="true" tabindex="-1"></a>      <span class="at">sf =</span> <span class="fu">map</span>(sf, \(x){ x <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="at">gid =</span> HEXID) } ) ) <span class="sc">|&gt;</span> </span>
<span id="cb9-182"><a href="#cb9-182" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unnest</span>(<span class="at">cols =</span> <span class="fu">c</span>(sf)) <span class="sc">|&gt;</span> </span>
<span id="cb9-183"><a href="#cb9-183" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>() <span class="sc">|&gt;</span> </span>
<span id="cb9-184"><a href="#cb9-184" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(gid) <span class="sc">|&gt;</span> </span>
<span id="cb9-185"><a href="#cb9-185" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_as_sf</span>() <span class="sc">|&gt;</span> </span>
<span id="cb9-186"><a href="#cb9-186" aria-hidden="true" tabindex="-1"></a>    <span class="co"># exclude "POLYGON" whole hexagon duplicates</span></span>
<span id="cb9-187"><a href="#cb9-187" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">st_geometry_type</span>(geometry) <span class="sc">==</span> <span class="st">"MULTIPOLYGON"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-188"><a href="#cb9-188" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">geom_id =</span> gid) <span class="sc">|&gt;</span> </span>
<span id="cb9-189"><a href="#cb9-189" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb9-190"><a href="#cb9-190" aria-hidden="true" tabindex="-1"></a>      <span class="at">geom_id =</span> <span class="fu">as.integer</span>(geom_id),</span>
<span id="cb9-191"><a href="#cb9-191" aria-hidden="true" tabindex="-1"></a>      <span class="at">ds_key  =</span> <span class="st">"gm"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-192"><a href="#cb9-192" aria-hidden="true" tabindex="-1"></a>    <span class="fu">relocate</span>(ds_key, <span class="at">.before =</span> geom_id) <span class="sc">|&gt;</span> </span>
<span id="cb9-193"><a href="#cb9-193" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="dv">4326</span>) <span class="sc">|&gt;</span> <span class="co"># from: USA_Contiguous_Lambert_Conformal_Conic</span></span>
<span id="cb9-194"><a href="#cb9-194" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mapView(d_geoms)</span></span>
<span id="cb9-195"><a href="#cb9-195" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_set_geometry</span>(<span class="st">"geom"</span>)</span>
<span id="cb9-196"><a href="#cb9-196" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-197"><a href="#cb9-197" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_write</span>(d_geoms, con, t_geoms, <span class="at">append =</span> T)</span>
<span id="cb9-198"><a href="#cb9-198" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-199"><a href="#cb9-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-200"><a href="#cb9-200" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> <span class="st">"SELECT * FROM sdm_geometries WHERE ds_key = 'gm'"</span></span>
<span id="cb9-201"><a href="#cb9-201" aria-hidden="true" tabindex="-1"></a><span class="co"># st_read(con, query = q) |&gt; </span></span>
<span id="cb9-202"><a href="#cb9-202" aria-hidden="true" tabindex="-1"></a><span class="co">#   mapView()</span></span>
<span id="cb9-203"><a href="#cb9-203" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-204"><a href="#cb9-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-205"><a href="#cb9-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-206"><a href="#cb9-206" aria-hidden="true" tabindex="-1"></a><span class="in">```{r d_vals}</span></span>
<span id="cb9-207"><a href="#cb9-207" aria-hidden="true" tabindex="-1"></a>t_vals <span class="ot">&lt;-</span> <span class="fu">Id</span>(<span class="at">schema =</span> schema, <span class="at">table =</span> <span class="st">"sdm_values"</span>)</span>
<span id="cb9-208"><a href="#cb9-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-209"><a href="#cb9-209" aria-hidden="true" tabindex="-1"></a>rows_exist <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, t_vals) <span class="sc">|&gt;</span> <span class="fu">filter</span>(ds_key <span class="sc">==</span> <span class="st">"gm"</span>) <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">pull</span>() <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb9-210"><a href="#cb9-210" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>rows_exist){</span>
<span id="cb9-211"><a href="#cb9-211" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-212"><a href="#cb9-212" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get unique values</span></span>
<span id="cb9-213"><a href="#cb9-213" aria-hidden="true" tabindex="-1"></a>  d_vals <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span> </span>
<span id="cb9-214"><a href="#cb9-214" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="at">sp_key =</span> taxa_sci, population, <span class="at">data =</span> sf) <span class="sc">|&gt;</span> </span>
<span id="cb9-215"><a href="#cb9-215" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb9-216"><a href="#cb9-216" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> <span class="fu">map</span>(data, \(x){</span>
<span id="cb9-217"><a href="#cb9-217" aria-hidden="true" tabindex="-1"></a>        x <span class="sc">|&gt;</span> </span>
<span id="cb9-218"><a href="#cb9-218" aria-hidden="true" tabindex="-1"></a>          <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb9-219"><a href="#cb9-219" aria-hidden="true" tabindex="-1"></a>          <span class="fu">rename</span>(<span class="at">geom_id =</span> HEXID) <span class="sc">|&gt;</span> </span>
<span id="cb9-220"><a href="#cb9-220" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pivot_longer</span>(</span>
<span id="cb9-221"><a href="#cb9-221" aria-hidden="true" tabindex="-1"></a>            <span class="at">cols      =</span> <span class="sc">-</span>geom_id,</span>
<span id="cb9-222"><a href="#cb9-222" aria-hidden="true" tabindex="-1"></a>            <span class="at">names_to  =</span> <span class="st">"mo_var"</span>,</span>
<span id="cb9-223"><a href="#cb9-223" aria-hidden="true" tabindex="-1"></a>            <span class="at">values_to =</span> <span class="st">"val"</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-224"><a href="#cb9-224" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(val <span class="sc">!=</span> <span class="sc">-</span><span class="dv">9999</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-225"><a href="#cb9-225" aria-hidden="true" tabindex="-1"></a>          <span class="fu">separate</span>(</span>
<span id="cb9-226"><a href="#cb9-226" aria-hidden="true" tabindex="-1"></a>            <span class="at">col  =</span> mo_var,</span>
<span id="cb9-227"><a href="#cb9-227" aria-hidden="true" tabindex="-1"></a>            <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"mo"</span>, <span class="st">"var"</span>),</span>
<span id="cb9-228"><a href="#cb9-228" aria-hidden="true" tabindex="-1"></a>            <span class="at">sep  =</span> <span class="st">"_"</span>)</span>
<span id="cb9-229"><a href="#cb9-229" aria-hidden="true" tabindex="-1"></a>        } ) ) <span class="sc">|&gt;</span> </span>
<span id="cb9-230"><a href="#cb9-230" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unnest</span>(<span class="at">cols =</span> <span class="fu">c</span>(data)) <span class="sc">|&gt;</span> </span>
<span id="cb9-231"><a href="#cb9-231" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb9-232"><a href="#cb9-232" aria-hidden="true" tabindex="-1"></a>      <span class="at">ds_key =</span> <span class="st">"gm"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-233"><a href="#cb9-233" aria-hidden="true" tabindex="-1"></a>    <span class="fu">relocate</span>(ds_key, <span class="at">.before =</span> taxa_sci)</span>
<span id="cb9-234"><a href="#cb9-234" aria-hidden="true" tabindex="-1"></a>  <span class="co"># A tibble: 15,445,842 × 7</span></span>
<span id="cb9-235"><a href="#cb9-235" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-236"><a href="#cb9-236" aria-hidden="true" tabindex="-1"></a>  yr <span class="ot">&lt;-</span> <span class="dv">2019</span> <span class="co"># using last year of obs/env so ISO 8601 compliant</span></span>
<span id="cb9-237"><a href="#cb9-237" aria-hidden="true" tabindex="-1"></a>  d_vals <span class="ot">&lt;-</span> d_vals <span class="sc">|&gt;</span> </span>
<span id="cb9-238"><a href="#cb9-238" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb9-239"><a href="#cb9-239" aria-hidden="true" tabindex="-1"></a>     <span class="at">mm            =</span> <span class="fu">setNames</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>, month.abb)[mo],</span>
<span id="cb9-240"><a href="#cb9-240" aria-hidden="true" tabindex="-1"></a>     <span class="at">mm_str        =</span> stringr<span class="sc">::</span><span class="fu">str_pad</span>(mm, <span class="dv">2</span>, <span class="at">pad =</span> <span class="st">"0"</span>),</span>
<span id="cb9-241"><a href="#cb9-241" aria-hidden="true" tabindex="-1"></a>     <span class="co"># Time Interval notation using [ISO 8601])(https://en.wikipedia.org/wiki/ISO_8601)</span></span>
<span id="cb9-242"><a href="#cb9-242" aria-hidden="true" tabindex="-1"></a>     <span class="at">time_interval =</span> <span class="fu">glue</span>(<span class="st">"{yr}-{mm_str}/P1M"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb9-243"><a href="#cb9-243" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(</span>
<span id="cb9-244"><a href="#cb9-244" aria-hidden="true" tabindex="-1"></a>      <span class="sc">-</span>mo, <span class="sc">-</span>mm, <span class="sc">-</span>mm_str)</span>
<span id="cb9-245"><a href="#cb9-245" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-246"><a href="#cb9-246" aria-hidden="true" tabindex="-1"></a>  <span class="co"># summarize d_vals to d_models</span></span>
<span id="cb9-247"><a href="#cb9-247" aria-hidden="true" tabindex="-1"></a>  d_mdls <span class="ot">&lt;-</span> d_vals <span class="sc">|&gt;</span> </span>
<span id="cb9-248"><a href="#cb9-248" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(</span>
<span id="cb9-249"><a href="#cb9-249" aria-hidden="true" tabindex="-1"></a>      ds_key, sp_key, population, time_interval, var) <span class="sc">|&gt;</span> </span>
<span id="cb9-250"><a href="#cb9-250" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-251"><a href="#cb9-251" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rowid_to_column</span>(<span class="st">"mdl_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-252"><a href="#cb9-252" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb9-253"><a href="#cb9-253" aria-hidden="true" tabindex="-1"></a>      <span class="at">mdl_id =</span> <span class="st">"gm"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb9-254"><a href="#cb9-254" aria-hidden="true" tabindex="-1"></a>    <span class="fu">relocate</span>(ds_key, <span class="at">.before =</span> mdl_id)</span>
<span id="cb9-255"><a href="#cb9-255" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-256"><a href="#cb9-256" aria-hidden="true" tabindex="-1"></a>  d_vals <span class="ot">&lt;-</span> d_vals <span class="sc">|&gt;</span> </span>
<span id="cb9-257"><a href="#cb9-257" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(</span>
<span id="cb9-258"><a href="#cb9-258" aria-hidden="true" tabindex="-1"></a>      d_models, </span>
<span id="cb9-259"><a href="#cb9-259" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"ds_key"</span>, <span class="st">"sp_key"</span>, <span class="st">"population"</span>, <span class="st">"time_interval"</span>, <span class="st">"var"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb9-260"><a href="#cb9-260" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(</span>
<span id="cb9-261"><a href="#cb9-261" aria-hidden="true" tabindex="-1"></a>      ds_key, mdl_id, geom_id, val)</span>
<span id="cb9-262"><a href="#cb9-262" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-263"><a href="#cb9-263" aria-hidden="true" tabindex="-1"></a>  d_spp <span class="ot">&lt;-</span> d_taxa <span class="sc">|&gt;</span> </span>
<span id="cb9-264"><a href="#cb9-264" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(taxa_sci) <span class="sc">|&gt;</span></span>
<span id="cb9-265"><a href="#cb9-265" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(</span>
<span id="cb9-266"><a href="#cb9-266" aria-hidden="true" tabindex="-1"></a>      <span class="at">taxa_common =</span> <span class="fu">first</span>(taxa_common) <span class="sc">|&gt;</span> <span class="fu">str_replace_all</span>(<span class="st">"Oceanic "</span>, <span class="st">""</span>) ) <span class="sc">|&gt;</span> </span>
<span id="cb9-267"><a href="#cb9-267" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb9-268"><a href="#cb9-268" aria-hidden="true" tabindex="-1"></a>      <span class="at">ds_key =</span> <span class="st">"gm"</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-269"><a href="#cb9-269" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(ds_key, <span class="at">sp_key =</span> taxa_sci, <span class="at">sp_common =</span> taxa_common) <span class="sc">|&gt;</span> </span>
<span id="cb9-270"><a href="#cb9-270" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb9-271"><a href="#cb9-271" aria-hidden="true" tabindex="-1"></a>      <span class="at">sp_scientific =</span> sp_key)</span>
<span id="cb9-272"><a href="#cb9-272" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-273"><a href="#cb9-273" aria-hidden="true" tabindex="-1"></a>  t_spp <span class="ot">&lt;-</span> <span class="fu">Id</span>(<span class="at">schema =</span> schema, <span class="at">table =</span> <span class="st">"sdm_species"</span>)</span>
<span id="cb9-274"><a href="#cb9-274" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-275"><a href="#cb9-275" aria-hidden="true" tabindex="-1"></a>  rows_exist <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, t_spp) <span class="sc">|&gt;</span> <span class="fu">filter</span>(ds_key <span class="sc">==</span> <span class="st">"gm"</span>) <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">pull</span>() <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb9-276"><a href="#cb9-276" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>rows_exist)</span>
<span id="cb9-277"><a href="#cb9-277" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dbWriteTable</span>(con, t_spp, d_spp, <span class="at">append =</span> T)</span>
<span id="cb9-278"><a href="#cb9-278" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-279"><a href="#cb9-279" aria-hidden="true" tabindex="-1"></a>  t_mdls <span class="ot">&lt;-</span> <span class="fu">Id</span>(<span class="at">schema =</span> schema, <span class="at">table =</span> <span class="st">"sdm_models"</span>)</span>
<span id="cb9-280"><a href="#cb9-280" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-281"><a href="#cb9-281" aria-hidden="true" tabindex="-1"></a>  rows_exist <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, t_mdls) <span class="sc">|&gt;</span> <span class="fu">filter</span>(ds_key <span class="sc">==</span> <span class="st">"gm"</span>) <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="fu">n</span>()) <span class="sc">|&gt;</span> <span class="fu">pull</span>() <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb9-282"><a href="#cb9-282" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>rows_exist)</span>
<span id="cb9-283"><a href="#cb9-283" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dbWriteTable</span>(con, t_mdls, d_mdls, <span class="at">append =</span> T)</span>
<span id="cb9-284"><a href="#cb9-284" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-285"><a href="#cb9-285" aria-hidden="true" tabindex="-1"></a>  <span class="co"># check: d_vals |&gt; select(mo, time_interval) |&gt; table()</span></span>
<span id="cb9-286"><a href="#cb9-286" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbWriteTable</span>(con, t_vals, d_vals, <span class="at">append =</span> T)</span>
<span id="cb9-287"><a href="#cb9-287" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-288"><a href="#cb9-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-289"><a href="#cb9-289" aria-hidden="true" tabindex="-1"></a>t_mdls <span class="ot">&lt;-</span> <span class="fu">Id</span>(<span class="at">schema =</span> schema, <span class="at">table =</span> <span class="st">"sdm_models"</span>)</span>
<span id="cb9-290"><a href="#cb9-290" aria-hidden="true" tabindex="-1"></a><span class="fu">tbl</span>(con, t_mdls) <span class="sc">|&gt;</span> </span>
<span id="cb9-291"><a href="#cb9-291" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>description) <span class="sc">|&gt;</span> </span>
<span id="cb9-292"><a href="#cb9-292" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span> </span>
<span id="cb9-293"><a href="#cb9-293" aria-hidden="true" tabindex="-1"></a>  <span class="fu">datatable</span>()</span>
<span id="cb9-294"><a href="#cb9-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-295"><a href="#cb9-295" aria-hidden="true" tabindex="-1"></a><span class="fu">tbl</span>(con, t_vals) <span class="sc">|&gt;</span> </span>
<span id="cb9-296"><a href="#cb9-296" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>() <span class="sc">|&gt;</span> </span>
<span id="cb9-297"><a href="#cb9-297" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>() <span class="sc">|&gt;</span> </span>
<span id="cb9-298"><a href="#cb9-298" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span>
<span id="cb9-299"><a href="#cb9-299" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-300"><a href="#cb9-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-301"><a href="#cb9-301" aria-hidden="true" tabindex="-1"></a>The map output is too big, but the following runs in RStudio.</span>
<span id="cb9-302"><a href="#cb9-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-303"><a href="#cb9-303" aria-hidden="true" tabindex="-1"></a><span class="in">```{r d_map}</span></span>
<span id="cb9-304"><a href="#cb9-304" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval:  FALSE</span></span>
<span id="cb9-305"><a href="#cb9-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-306"><a href="#cb9-306" aria-hidden="true" tabindex="-1"></a><span class="co"># build query</span></span>
<span id="cb9-307"><a href="#cb9-307" aria-hidden="true" tabindex="-1"></a><span class="co"># tbl(con, t_mdls) |&gt;</span></span>
<span id="cb9-308"><a href="#cb9-308" aria-hidden="true" tabindex="-1"></a><span class="co">#   filter(</span></span>
<span id="cb9-309"><a href="#cb9-309" aria-hidden="true" tabindex="-1"></a><span class="co">#     ds_key        == "gm",</span></span>
<span id="cb9-310"><a href="#cb9-310" aria-hidden="true" tabindex="-1"></a><span class="co">#     # sp_key        == "Stenella frontalis",</span></span>
<span id="cb9-311"><a href="#cb9-311" aria-hidden="true" tabindex="-1"></a><span class="co">#     # population    == "Oceanic",</span></span>
<span id="cb9-312"><a href="#cb9-312" aria-hidden="true" tabindex="-1"></a><span class="co">#     sp_key        == "Balaenoptera ricei",</span></span>
<span id="cb9-313"><a href="#cb9-313" aria-hidden="true" tabindex="-1"></a><span class="co">#     time_interval == "2019-01/P1M",</span></span>
<span id="cb9-314"><a href="#cb9-314" aria-hidden="true" tabindex="-1"></a><span class="co">#     var           == "n") |&gt;</span></span>
<span id="cb9-315"><a href="#cb9-315" aria-hidden="true" tabindex="-1"></a><span class="co">#   select(ds_key, mdl_id) |&gt; </span></span>
<span id="cb9-316"><a href="#cb9-316" aria-hidden="true" tabindex="-1"></a><span class="co">#   left_join(</span></span>
<span id="cb9-317"><a href="#cb9-317" aria-hidden="true" tabindex="-1"></a><span class="co">#     tbl(con, t_vals),</span></span>
<span id="cb9-318"><a href="#cb9-318" aria-hidden="true" tabindex="-1"></a><span class="co">#     by = c("ds_key", "mdl_id") ) |&gt;</span></span>
<span id="cb9-319"><a href="#cb9-319" aria-hidden="true" tabindex="-1"></a><span class="co">#   left_join(</span></span>
<span id="cb9-320"><a href="#cb9-320" aria-hidden="true" tabindex="-1"></a><span class="co">#     tbl(con, t_geoms),</span></span>
<span id="cb9-321"><a href="#cb9-321" aria-hidden="true" tabindex="-1"></a><span class="co">#     by = c("ds_key", "geom_id")) |&gt; </span></span>
<span id="cb9-322"><a href="#cb9-322" aria-hidden="true" tabindex="-1"></a><span class="co">#   select(val, geom) |&gt; </span></span>
<span id="cb9-323"><a href="#cb9-323" aria-hidden="true" tabindex="-1"></a><span class="co">#   show_query() # explain()</span></span>
<span id="cb9-324"><a href="#cb9-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-325"><a href="#cb9-325" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb9-326"><a href="#cb9-326" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT v.val, g.geom</span></span>
<span id="cb9-327"><a href="#cb9-327" aria-hidden="true" tabindex="-1"></a><span class="st">FROM (</span></span>
<span id="cb9-328"><a href="#cb9-328" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT ds_key, mdl_id</span></span>
<span id="cb9-329"><a href="#cb9-329" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM public.sdm_models</span></span>
<span id="cb9-330"><a href="#cb9-330" aria-hidden="true" tabindex="-1"></a><span class="st">  WHERE</span></span>
<span id="cb9-331"><a href="#cb9-331" aria-hidden="true" tabindex="-1"></a><span class="st">    ds_key        = 'gm'                 AND</span></span>
<span id="cb9-332"><a href="#cb9-332" aria-hidden="true" tabindex="-1"></a><span class="st"> -- sp_key        = 'Stenella frontalis' AND</span></span>
<span id="cb9-333"><a href="#cb9-333" aria-hidden="true" tabindex="-1"></a><span class="st"> -- population    = 'Oceanic'            AND</span></span>
<span id="cb9-334"><a href="#cb9-334" aria-hidden="true" tabindex="-1"></a><span class="st">    sp_key        = 'Balaenoptera ricei' AND</span></span>
<span id="cb9-335"><a href="#cb9-335" aria-hidden="true" tabindex="-1"></a><span class="st">    time_interval = '2019-01/P1M'     AND</span></span>
<span id="cb9-336"><a href="#cb9-336" aria-hidden="true" tabindex="-1"></a><span class="st">    var           = 'n' ) AS m</span></span>
<span id="cb9-337"><a href="#cb9-337" aria-hidden="true" tabindex="-1"></a><span class="st">LEFT JOIN public.sdm_values AS v ON (</span></span>
<span id="cb9-338"><a href="#cb9-338" aria-hidden="true" tabindex="-1"></a><span class="st">  m.ds_key = v.ds_key AND</span></span>
<span id="cb9-339"><a href="#cb9-339" aria-hidden="true" tabindex="-1"></a><span class="st">  m.mdl_id = v.mdl_id )</span></span>
<span id="cb9-340"><a href="#cb9-340" aria-hidden="true" tabindex="-1"></a><span class="st">LEFT JOIN public.sdm_geometries AS g ON (</span></span>
<span id="cb9-341"><a href="#cb9-341" aria-hidden="true" tabindex="-1"></a><span class="st">  m.ds_key  = g.ds_key AND</span></span>
<span id="cb9-342"><a href="#cb9-342" aria-hidden="true" tabindex="-1"></a><span class="st">  v.geom_id = g.geom_id )"</span></span>
<span id="cb9-343"><a href="#cb9-343" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">st_read</span>(con, <span class="at">query =</span> q)</span>
<span id="cb9-344"><a href="#cb9-344" aria-hidden="true" tabindex="-1"></a><span class="fu">mapView</span>(p)</span>
<span id="cb9-345"><a href="#cb9-345" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb9-346"><a href="#cb9-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-347"><a href="#cb9-347" aria-hidden="true" tabindex="-1"></a><span class="al">![Screenshot of running above query in RStudio.](./figures/ingest_sdm-gm_mapview.png)</span></span>
<span id="cb9-348"><a href="#cb9-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-349"><a href="#cb9-349" aria-hidden="true" tabindex="-1"></a><span class="in">```{r OLD}</span></span>
<span id="cb9-350"><a href="#cb9-350" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: FALSE</span></span>
<span id="cb9-351"><a href="#cb9-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-352"><a href="#cb9-352" aria-hidden="true" tabindex="-1"></a>gm_models <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span></span>
<span id="cb9-353"><a href="#cb9-353" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(mdl_id, taxa_sci, taxa_doc, months, n_months)</span>
<span id="cb9-354"><a href="#cb9-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-355"><a href="#cb9-355" aria-hidden="true" tabindex="-1"></a>mdl_hex <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span></span>
<span id="cb9-356"><a href="#cb9-356" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb9-357"><a href="#cb9-357" aria-hidden="true" tabindex="-1"></a>    mdl_id, d_density) <span class="sc">%&gt;%</span></span>
<span id="cb9-358"><a href="#cb9-358" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(d_density)</span>
<span id="cb9-359"><a href="#cb9-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-360"><a href="#cb9-360" aria-hidden="true" tabindex="-1"></a>gm_model_hexagons <span class="ot">&lt;-</span> mdl_hex <span class="sc">%&gt;%</span></span>
<span id="cb9-361"><a href="#cb9-361" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(hexid, geom) <span class="sc">%&gt;%</span></span>
<span id="cb9-362"><a href="#cb9-362" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">.groups=</span><span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-363"><a href="#cb9-363" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>()</span>
<span id="cb9-364"><a href="#cb9-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-365"><a href="#cb9-365" aria-hidden="true" tabindex="-1"></a>gm_model_hexagon_densities<span class="ot">&lt;-</span> mdl_hex <span class="sc">%&gt;%</span></span>
<span id="cb9-366"><a href="#cb9-366" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb9-367"><a href="#cb9-367" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(mdl_id, hexid, density) <span class="sc">%&gt;%</span></span>
<span id="cb9-368"><a href="#cb9-368" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(density))</span>
<span id="cb9-369"><a href="#cb9-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-370"><a href="#cb9-370" aria-hidden="true" tabindex="-1"></a><span class="co"># helper functions ----</span></span>
<span id="cb9-371"><a href="#cb9-371" aria-hidden="true" tabindex="-1"></a>get_annual_density <span class="ot">&lt;-</span> <span class="cf">function</span>(d_sf, <span class="at">i=</span><span class="dv">0</span>){</span>
<span id="cb9-372"><a href="#cb9-372" aria-hidden="true" tabindex="-1"></a>  <span class="co"># i = 12; d_sf &lt;- d$sf[[i]]</span></span>
<span id="cb9-373"><a href="#cb9-373" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"{i} of {nrow(d)} in get_annual_density() ~ {Sys.time()}"</span>))</span>
<span id="cb9-374"><a href="#cb9-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-375"><a href="#cb9-375" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get geometries</span></span>
<span id="cb9-376"><a href="#cb9-376" aria-hidden="true" tabindex="-1"></a>  geoms <span class="ot">&lt;-</span> d_sf <span class="sc">%&gt;%</span></span>
<span id="cb9-377"><a href="#cb9-377" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="at">hexid =</span> HEXID, <span class="at">geom =</span> geometry)</span>
<span id="cb9-378"><a href="#cb9-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-379"><a href="#cb9-379" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get *_n abundance (#/40km2) per month and calculate annual average density (#/km2)</span></span>
<span id="cb9-380"><a href="#cb9-380" aria-hidden="true" tabindex="-1"></a>  mos_n <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{month.abb}_n"</span>)</span>
<span id="cb9-381"><a href="#cb9-381" aria-hidden="true" tabindex="-1"></a>  attrs <span class="ot">&lt;-</span> d_sf <span class="sc">%&gt;%</span></span>
<span id="cb9-382"><a href="#cb9-382" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb9-383"><a href="#cb9-383" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="at">hexid =</span> HEXID, <span class="fu">any_of</span>(mos_n)) <span class="sc">%&gt;%</span></span>
<span id="cb9-384"><a href="#cb9-384" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="sc">-</span>hexid, <span class="at">names_to =</span> <span class="st">"mo_n"</span>, <span class="at">values_to =</span> <span class="st">"n"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-385"><a href="#cb9-385" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(n <span class="sc">!=</span> <span class="sc">-</span><span class="dv">9999</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-386"><a href="#cb9-386" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(hexid) <span class="sc">%&gt;%</span></span>
<span id="cb9-387"><a href="#cb9-387" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(</span>
<span id="cb9-388"><a href="#cb9-388" aria-hidden="true" tabindex="-1"></a>      <span class="at">n =</span> <span class="fu">mean</span>(n),</span>
<span id="cb9-389"><a href="#cb9-389" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-390"><a href="#cb9-390" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb9-391"><a href="#cb9-391" aria-hidden="true" tabindex="-1"></a>      <span class="at">density =</span> n <span class="sc">/</span> <span class="dv">40</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-392"><a href="#cb9-392" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(hexid, density) <span class="co"># individuals / km2</span></span>
<span id="cb9-393"><a href="#cb9-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-394"><a href="#cb9-394" aria-hidden="true" tabindex="-1"></a>  <span class="co"># return geometries joined with summarized attributes</span></span>
<span id="cb9-395"><a href="#cb9-395" aria-hidden="true" tabindex="-1"></a>  d_sum <span class="ot">&lt;-</span> geoms <span class="sc">%&gt;%</span></span>
<span id="cb9-396"><a href="#cb9-396" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(</span>
<span id="cb9-397"><a href="#cb9-397" aria-hidden="true" tabindex="-1"></a>      attrs, <span class="at">by =</span> <span class="st">"hexid"</span>)</span>
<span id="cb9-398"><a href="#cb9-398" aria-hidden="true" tabindex="-1"></a>  d_sum</span>
<span id="cb9-399"><a href="#cb9-399" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-400"><a href="#cb9-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-401"><a href="#cb9-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-402"><a href="#cb9-402" aria-hidden="true" tabindex="-1"></a><span class="co"># add aphia_id ----</span></span>
<span id="cb9-403"><a href="#cb9-403" aria-hidden="true" tabindex="-1"></a>gm_models <span class="ot">&lt;-</span> <span class="fu">wm_add_aphia_id</span>(gm_models, taxa_sci)</span>
<span id="cb9-404"><a href="#cb9-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-405"><a href="#cb9-405" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">?: combine Oceanic_* &amp; Shelf_* for AtlanticSpotted_Dolphin + CommonBottlenose_Dolphin</span></span>
<span id="cb9-406"><a href="#cb9-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-407"><a href="#cb9-407" aria-hidden="true" tabindex="-1"></a><span class="co"># write to database ----</span></span>
<span id="cb9-408"><a href="#cb9-408" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">oh_pg_con</span>()</span>
<span id="cb9-409"><a href="#cb9-409" aria-hidden="true" tabindex="-1"></a><span class="fu">dbWriteTable</span>(con, <span class="st">"gm_models"</span>, gm_models, <span class="at">overwrite=</span>T)</span>
<span id="cb9-410"><a href="#cb9-410" aria-hidden="true" tabindex="-1"></a><span class="fu">st_write</span>(gm_model_hexagons, con, <span class="st">"gm_model_hexagons"</span>, <span class="at">delete_layer=</span>T)</span>
<span id="cb9-411"><a href="#cb9-411" aria-hidden="true" tabindex="-1"></a><span class="fu">dbWriteTable</span>(con, <span class="st">"gm_model_hexagon_densities"</span>, gm_model_hexagon_densities, <span class="at">overwrite=</span>T)</span>
<span id="cb9-412"><a href="#cb9-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-413"><a href="#cb9-413" aria-hidden="true" tabindex="-1"></a><span class="fu">create_index</span>(con, <span class="st">"gm_models"</span>, <span class="st">"mdl_id"</span>, <span class="at">unique =</span> T)</span>
<span id="cb9-414"><a href="#cb9-414" aria-hidden="true" tabindex="-1"></a><span class="fu">create_index</span>(con, <span class="st">"gm_model_hexagons"</span>, <span class="st">"hexid"</span>, <span class="at">unique =</span> T)</span>
<span id="cb9-415"><a href="#cb9-415" aria-hidden="true" tabindex="-1"></a><span class="fu">create_index</span>(con, <span class="st">"gm_model_hexagon_densities"</span>, <span class="fu">c</span>(<span class="st">"mdl_id"</span>, <span class="st">"hexid"</span>), <span class="at">unique =</span> T)</span>
<span id="cb9-416"><a href="#cb9-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-417"><a href="#cb9-417" aria-hidden="true" tabindex="-1"></a><span class="co"># hexid x cell_id ----</span></span>
<span id="cb9-418"><a href="#cb9-418" aria-hidden="true" tabindex="-1"></a><span class="fu">tbl</span>(con, <span class="st">"gm_model_hexagons"</span>)</span>
<span id="cb9-419"><a href="#cb9-419" aria-hidden="true" tabindex="-1"></a>oh_cells_ply <span class="ot">&lt;-</span> <span class="fu">dbGetQuery</span>(</span>
<span id="cb9-420"><a href="#cb9-420" aria-hidden="true" tabindex="-1"></a>  con,</span>
<span id="cb9-421"><a href="#cb9-421" aria-hidden="true" tabindex="-1"></a>  <span class="st">"WITH</span></span>
<span id="cb9-422"><a href="#cb9-422" aria-hidden="true" tabindex="-1"></a><span class="st">  c  AS (</span></span>
<span id="cb9-423"><a href="#cb9-423" aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT</span></span>
<span id="cb9-424"><a href="#cb9-424" aria-hidden="true" tabindex="-1"></a><span class="st">      cell_id, geom</span></span>
<span id="cb9-425"><a href="#cb9-425" aria-hidden="true" tabindex="-1"></a><span class="st">    FROM oh_cells),</span></span>
<span id="cb9-426"><a href="#cb9-426" aria-hidden="true" tabindex="-1"></a><span class="st">  d AS (</span></span>
<span id="cb9-427"><a href="#cb9-427" aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT</span></span>
<span id="cb9-428"><a href="#cb9-428" aria-hidden="true" tabindex="-1"></a><span class="st">      hexid AS ply_id, ST_Transform(geom, 4326) AS geom</span></span>
<span id="cb9-429"><a href="#cb9-429" aria-hidden="true" tabindex="-1"></a><span class="st">    FROM gm_model_hexagons)</span></span>
<span id="cb9-430"><a href="#cb9-430" aria-hidden="true" tabindex="-1"></a><span class="st">  SELECT DISTINCT ON (tbl, ply_id, cell_id)</span></span>
<span id="cb9-431"><a href="#cb9-431" aria-hidden="true" tabindex="-1"></a><span class="st">    'gm_model_hexagons' AS tbl,</span></span>
<span id="cb9-432"><a href="#cb9-432" aria-hidden="true" tabindex="-1"></a><span class="st">    d.ply_id,</span></span>
<span id="cb9-433"><a href="#cb9-433" aria-hidden="true" tabindex="-1"></a><span class="st">    c.cell_id</span></span>
<span id="cb9-434"><a href="#cb9-434" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM c JOIN</span></span>
<span id="cb9-435"><a href="#cb9-435" aria-hidden="true" tabindex="-1"></a><span class="st">    d ON ST_Covers(d.geom, c.geom)"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-436"><a href="#cb9-436" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>()</span>
<span id="cb9-437"><a href="#cb9-437" aria-hidden="true" tabindex="-1"></a>oh_cells_ply</span>
<span id="cb9-438"><a href="#cb9-438" aria-hidden="true" tabindex="-1"></a><span class="fu">dbSendQuery</span>(con, <span class="st">"DELETE FROM oh_cells_ply WHERE tbl = 'gm_model_hexagons'"</span>)</span>
<span id="cb9-439"><a href="#cb9-439" aria-hidden="true" tabindex="-1"></a><span class="fu">dbAppendTable</span>(con, <span class="st">"oh_cells_ply"</span>, oh_cells_ply)</span>
<span id="cb9-440"><a href="#cb9-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-441"><a href="#cb9-441" aria-hidden="true" tabindex="-1"></a><span class="co"># test model output ----</span></span>
<span id="cb9-442"><a href="#cb9-442" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> <span class="fu">oh_pg_con</span>()</span>
<span id="cb9-443"><a href="#cb9-443" aria-hidden="true" tabindex="-1"></a>r_d <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con, <span class="st">"gm_models"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-444"><a href="#cb9-444" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(taxa_sci <span class="sc">==</span> <span class="st">"Ziphius"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-445"><a href="#cb9-445" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb9-446"><a href="#cb9-446" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tbl</span>(con, <span class="st">"gm_model_hexagon_densities"</span>),</span>
<span id="cb9-447"><a href="#cb9-447" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"mdl_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-448"><a href="#cb9-448" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb9-449"><a href="#cb9-449" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tbl</span>(con, <span class="st">"oh_cells_ply"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-450"><a href="#cb9-450" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(tbl <span class="sc">==</span> <span class="st">"gm_model_hexagons"</span>),</span>
<span id="cb9-451"><a href="#cb9-451" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"hexid"</span> <span class="ot">=</span> <span class="st">"ply_id"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb9-452"><a href="#cb9-452" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(cell_id, density) <span class="sc">%&gt;%</span></span>
<span id="cb9-453"><a href="#cb9-453" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(            <span class="co"># 1,977,010 -&gt; 1,959,979</span></span>
<span id="cb9-454"><a href="#cb9-454" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(cell_id),</span>
<span id="cb9-455"><a href="#cb9-455" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(density)) <span class="sc">%&gt;%</span></span>
<span id="cb9-456"><a href="#cb9-456" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb9-457"><a href="#cb9-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-458"><a href="#cb9-458" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb9-459"><a href="#cb9-459" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">oh_rast</span>()</span>
<span id="cb9-460"><a href="#cb9-460" aria-hidden="true" tabindex="-1"></a>r[r_d<span class="sc">$</span>cell_id] <span class="ot">&lt;-</span> r_d<span class="sc">$</span>density</span>
<span id="cb9-461"><a href="#cb9-461" aria-hidden="true" tabindex="-1"></a>tmp_tif <span class="ot">&lt;-</span> <span class="fu">tempfile</span>(<span class="at">fileext =</span> <span class="st">".tif"</span>)</span>
<span id="cb9-462"><a href="#cb9-462" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">trim</span>(r)</span>
<span id="cb9-463"><a href="#cb9-463" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(r)</span>
<span id="cb9-464"><a href="#cb9-464" aria-hidden="true" tabindex="-1"></a><span class="fu">mapView</span>(r, <span class="at">maxpixels=</span><span class="fu">ncell</span>(r))</span>
<span id="cb9-465"><a href="#cb9-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-466"><a href="#cb9-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-467"><a href="#cb9-467" aria-hidden="true" tabindex="-1"></a><span class="co"># redo rast ----</span></span>
<span id="cb9-468"><a href="#cb9-468" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb9-469"><a href="#cb9-469" aria-hidden="true" tabindex="-1"></a>  here, readr, terra)</span>
<span id="cb9-470"><a href="#cb9-470" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">readr.show_col_types =</span> F)</span>
<span id="cb9-471"><a href="#cb9-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-472"><a href="#cb9-472" aria-hidden="true" tabindex="-1"></a>dir_lyrs_tif <span class="ot">&lt;-</span> <span class="st">"/Users/bbest/My Drive/projects/offhab/data/derived/lyrs_tif"</span></span>
<span id="cb9-473"><a href="#cb9-473" aria-hidden="true" tabindex="-1"></a>lyrs_csv     <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data-raw/layers.csv"</span>)</span>
<span id="cb9-474"><a href="#cb9-474" aria-hidden="true" tabindex="-1"></a>ds_key       <span class="ot">&lt;-</span> <span class="st">"gm"</span></span>
<span id="cb9-475"><a href="#cb9-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-476"><a href="#cb9-476" aria-hidden="true" tabindex="-1"></a><span class="co"># match with aphia_id</span></span>
<span id="cb9-477"><a href="#cb9-477" aria-hidden="true" tabindex="-1"></a>D <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb9-478"><a href="#cb9-478" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb9-479"><a href="#cb9-479" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tbl</span>(con, <span class="st">"taxa"</span>) <span class="sc">|&gt;</span> <span class="co"># distinct(tbl) |&gt; pull(tbl)</span></span>
<span id="cb9-480"><a href="#cb9-480" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(tbl <span class="sc">==</span> <span class="st">"gm_models"</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-481"><a href="#cb9-481" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(</span>
<span id="cb9-482"><a href="#cb9-482" aria-hidden="true" tabindex="-1"></a>        <span class="at">taxa_sci =</span> taxa,</span>
<span id="cb9-483"><a href="#cb9-483" aria-hidden="true" tabindex="-1"></a>        aphia_id) <span class="sc">|&gt;</span></span>
<span id="cb9-484"><a href="#cb9-484" aria-hidden="true" tabindex="-1"></a>      <span class="fu">collect</span>(),</span>
<span id="cb9-485"><a href="#cb9-485" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"taxa_sci"</span>)</span>
<span id="cb9-486"><a href="#cb9-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-487"><a href="#cb9-487" aria-hidden="true" tabindex="-1"></a><span class="co"># combine:</span></span>
<span id="cb9-488"><a href="#cb9-488" aria-hidden="true" tabindex="-1"></a><span class="co">#           Stenella frontalis | Tursiops truncatus</span></span>
<span id="cb9-489"><a href="#cb9-489" aria-hidden="true" tabindex="-1"></a><span class="co">#  oceanic |                 8 |                  9</span></span>
<span id="cb9-490"><a href="#cb9-490" aria-hidden="true" tabindex="-1"></a><span class="co">#    shelf |                15 |                 16</span></span>
<span id="cb9-491"><a href="#cb9-491" aria-hidden="true" tabindex="-1"></a>d_sf <span class="ot">&lt;-</span> D <span class="sc">|&gt;</span></span>
<span id="cb9-492"><a href="#cb9-492" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb9-493"><a href="#cb9-493" aria-hidden="true" tabindex="-1"></a>    mdl_id <span class="sc">==</span> <span class="dv">8</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-494"><a href="#cb9-494" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(aphia_id, d_density) <span class="sc">|&gt;</span></span>
<span id="cb9-495"><a href="#cb9-495" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(d_density) <span class="sc">|&gt;</span></span>
<span id="cb9-496"><a href="#cb9-496" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">density_oceanic =</span> density) <span class="sc">|&gt;</span></span>
<span id="cb9-497"><a href="#cb9-497" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb9-498"><a href="#cb9-498" aria-hidden="true" tabindex="-1"></a>    D <span class="sc">|&gt;</span></span>
<span id="cb9-499"><a href="#cb9-499" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(</span>
<span id="cb9-500"><a href="#cb9-500" aria-hidden="true" tabindex="-1"></a>        mdl_id <span class="sc">==</span> <span class="dv">15</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-501"><a href="#cb9-501" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(mdl_id, d_density) <span class="sc">|&gt;</span></span>
<span id="cb9-502"><a href="#cb9-502" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unnest</span>(d_density) <span class="sc">|&gt;</span></span>
<span id="cb9-503"><a href="#cb9-503" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(</span>
<span id="cb9-504"><a href="#cb9-504" aria-hidden="true" tabindex="-1"></a>        hexid, <span class="at">density_shelf =</span> density),</span>
<span id="cb9-505"><a href="#cb9-505" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"hexid"</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-506"><a href="#cb9-506" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb9-507"><a href="#cb9-507" aria-hidden="true" tabindex="-1"></a>    <span class="at">density =</span> <span class="fu">map2_dbl</span>(</span>
<span id="cb9-508"><a href="#cb9-508" aria-hidden="true" tabindex="-1"></a>      density_oceanic, density_shelf, sum, <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span></span>
<span id="cb9-509"><a href="#cb9-509" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>density_oceanic, <span class="sc">-</span>density_shelf) <span class="sc">|&gt;</span></span>
<span id="cb9-510"><a href="#cb9-510" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>(</span>
<span id="cb9-511"><a href="#cb9-511" aria-hidden="true" tabindex="-1"></a>    <span class="at">d_density =</span> <span class="fu">c</span>(hexid, geom, density))</span>
<span id="cb9-512"><a href="#cb9-512" aria-hidden="true" tabindex="-1"></a>d_tt <span class="ot">&lt;-</span> D <span class="sc">|&gt;</span></span>
<span id="cb9-513"><a href="#cb9-513" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb9-514"><a href="#cb9-514" aria-hidden="true" tabindex="-1"></a>    mdl_id <span class="sc">==</span> <span class="dv">9</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-515"><a href="#cb9-515" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(aphia_id, d_density) <span class="sc">|&gt;</span></span>
<span id="cb9-516"><a href="#cb9-516" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(d_density) <span class="sc">|&gt;</span></span>
<span id="cb9-517"><a href="#cb9-517" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">density_oceanic =</span> density) <span class="sc">|&gt;</span></span>
<span id="cb9-518"><a href="#cb9-518" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb9-519"><a href="#cb9-519" aria-hidden="true" tabindex="-1"></a>    D <span class="sc">|&gt;</span></span>
<span id="cb9-520"><a href="#cb9-520" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(</span>
<span id="cb9-521"><a href="#cb9-521" aria-hidden="true" tabindex="-1"></a>        mdl_id <span class="sc">==</span> <span class="dv">16</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-522"><a href="#cb9-522" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(mdl_id, d_density) <span class="sc">|&gt;</span></span>
<span id="cb9-523"><a href="#cb9-523" aria-hidden="true" tabindex="-1"></a>      <span class="fu">unnest</span>(d_density) <span class="sc">|&gt;</span></span>
<span id="cb9-524"><a href="#cb9-524" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(</span>
<span id="cb9-525"><a href="#cb9-525" aria-hidden="true" tabindex="-1"></a>        hexid, <span class="at">density_shelf =</span> density),</span>
<span id="cb9-526"><a href="#cb9-526" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"hexid"</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-527"><a href="#cb9-527" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb9-528"><a href="#cb9-528" aria-hidden="true" tabindex="-1"></a>    <span class="at">density =</span> <span class="fu">map2_dbl</span>(</span>
<span id="cb9-529"><a href="#cb9-529" aria-hidden="true" tabindex="-1"></a>      density_oceanic, density_shelf, sum, <span class="at">na.rm =</span> T)) <span class="sc">|&gt;</span></span>
<span id="cb9-530"><a href="#cb9-530" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>density_oceanic, <span class="sc">-</span>density_shelf) <span class="sc">|&gt;</span></span>
<span id="cb9-531"><a href="#cb9-531" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>(</span>
<span id="cb9-532"><a href="#cb9-532" aria-hidden="true" tabindex="-1"></a>    <span class="at">d_density =</span> <span class="fu">c</span>(hexid, geom, density))</span>
<span id="cb9-533"><a href="#cb9-533" aria-hidden="true" tabindex="-1"></a>D <span class="ot">&lt;-</span> D <span class="sc">|&gt;</span></span>
<span id="cb9-534"><a href="#cb9-534" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>mdl_id <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">8</span>,<span class="dv">9</span>,<span class="dv">15</span>,<span class="dv">16</span>)) <span class="sc">|&gt;</span></span>
<span id="cb9-535"><a href="#cb9-535" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(aphia_id, d_density) <span class="sc">|&gt;</span></span>
<span id="cb9-536"><a href="#cb9-536" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbind</span>(</span>
<span id="cb9-537"><a href="#cb9-537" aria-hidden="true" tabindex="-1"></a>    d_sf,</span>
<span id="cb9-538"><a href="#cb9-538" aria-hidden="true" tabindex="-1"></a>    d_tt)</span>
<span id="cb9-539"><a href="#cb9-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-540"><a href="#cb9-540" aria-hidden="true" tabindex="-1"></a><span class="co"># iterate over rasters</span></span>
<span id="cb9-541"><a href="#cb9-541" aria-hidden="true" tabindex="-1"></a>r_na <span class="ot">&lt;-</span> <span class="fu">oh_rast</span>(<span class="st">"NA"</span>)</span>
<span id="cb9-542"><a href="#cb9-542" aria-hidden="true" tabindex="-1"></a><span class="co"># for (i in 1:nrow(D)){ # i = 1</span></span>
<span id="cb9-543"><a href="#cb9-543" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">16</span><span class="sc">:</span><span class="fu">nrow</span>(D)){ <span class="co"># i = 16</span></span>
<span id="cb9-544"><a href="#cb9-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-545"><a href="#cb9-545" aria-hidden="true" tabindex="-1"></a>  aphia_id <span class="ot">&lt;-</span> D<span class="sc">$</span>aphia_id[i]</span>
<span id="cb9-546"><a href="#cb9-546" aria-hidden="true" tabindex="-1"></a>  lyr_key <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{ds_key}_{aphia_id}"</span>)</span>
<span id="cb9-547"><a href="#cb9-547" aria-hidden="true" tabindex="-1"></a>  r_tif <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{dir_lyrs_tif}/{lyr_key}.tif"</span>)</span>
<span id="cb9-548"><a href="#cb9-548" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">glue</span>(<span class="st">"{i} of {nrow(D)}: {basename(r_tif)} ~ {Sys.time()}"</span>))</span>
<span id="cb9-549"><a href="#cb9-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-550"><a href="#cb9-550" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get density, geom</span></span>
<span id="cb9-551"><a href="#cb9-551" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> D <span class="sc">|&gt;</span></span>
<span id="cb9-552"><a href="#cb9-552" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(i) <span class="sc">|&gt;</span></span>
<span id="cb9-553"><a href="#cb9-553" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(d_density) <span class="sc">%&gt;%</span></span>
<span id="cb9-554"><a href="#cb9-554" aria-hidden="true" tabindex="-1"></a>    .[[<span class="dv">1</span>]] <span class="sc">|&gt;</span></span>
<span id="cb9-555"><a href="#cb9-555" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_as_sf</span>()</span>
<span id="cb9-556"><a href="#cb9-556" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mapView(d, zcol = "density")</span></span>
<span id="cb9-557"><a href="#cb9-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-558"><a href="#cb9-558" aria-hidden="true" tabindex="-1"></a>  <span class="co"># convert to raster</span></span>
<span id="cb9-559"><a href="#cb9-559" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> d <span class="sc">|&gt;</span></span>
<span id="cb9-560"><a href="#cb9-560" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="dv">3857</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-561"><a href="#cb9-561" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rasterize</span>(</span>
<span id="cb9-562"><a href="#cb9-562" aria-hidden="true" tabindex="-1"></a>      r_na, <span class="st">"density"</span>)</span>
<span id="cb9-563"><a href="#cb9-563" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plet(r, tiles="Esri.NatGeoWorldMap")</span></span>
<span id="cb9-564"><a href="#cb9-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-565"><a href="#cb9-565" aria-hidden="true" tabindex="-1"></a>  <span class="co"># rescale 0 to 100; set 0 -&gt; NA</span></span>
<span id="cb9-566"><a href="#cb9-566" aria-hidden="true" tabindex="-1"></a>  (vr <span class="ot">&lt;-</span> <span class="fu">range</span>(<span class="fu">values</span>(r, <span class="at">na.rm =</span> T)))</span>
<span id="cb9-567"><a href="#cb9-567" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> <span class="fu">setValues</span>(</span>
<span id="cb9-568"><a href="#cb9-568" aria-hidden="true" tabindex="-1"></a>    r,</span>
<span id="cb9-569"><a href="#cb9-569" aria-hidden="true" tabindex="-1"></a>    scales<span class="sc">::</span><span class="fu">rescale</span>(</span>
<span id="cb9-570"><a href="#cb9-570" aria-hidden="true" tabindex="-1"></a>      <span class="fu">values</span>(r),</span>
<span id="cb9-571"><a href="#cb9-571" aria-hidden="true" tabindex="-1"></a>      <span class="at">to =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">100</span>)) )</span>
<span id="cb9-572"><a href="#cb9-572" aria-hidden="true" tabindex="-1"></a>  r[r<span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb9-573"><a href="#cb9-573" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plet(r, tiles="Esri.NatGeoWorldMap")</span></span>
<span id="cb9-574"><a href="#cb9-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-575"><a href="#cb9-575" aria-hidden="true" tabindex="-1"></a>  <span class="co"># write raster</span></span>
<span id="cb9-576"><a href="#cb9-576" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_rast</span>(r, r_tif)</span>
<span id="cb9-577"><a href="#cb9-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-578"><a href="#cb9-578" aria-hidden="true" tabindex="-1"></a>  <span class="co"># write min, max to layers.csv</span></span>
<span id="cb9-579"><a href="#cb9-579" aria-hidden="true" tabindex="-1"></a>  d <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(lyrs_csv) <span class="sc">|&gt;</span></span>
<span id="cb9-580"><a href="#cb9-580" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(</span>
<span id="cb9-581"><a href="#cb9-581" aria-hidden="true" tabindex="-1"></a>      lyr_key <span class="sc">!=</span> <span class="sc">!!</span>lyr_key) <span class="sc">|&gt;</span></span>
<span id="cb9-582"><a href="#cb9-582" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(</span>
<span id="cb9-583"><a href="#cb9-583" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tibble</span>(</span>
<span id="cb9-584"><a href="#cb9-584" aria-hidden="true" tabindex="-1"></a>        <span class="at">lyr_key     =</span> lyr_key,</span>
<span id="cb9-585"><a href="#cb9-585" aria-hidden="true" tabindex="-1"></a>        <span class="at">ds_key      =</span> ds_key,</span>
<span id="cb9-586"><a href="#cb9-586" aria-hidden="true" tabindex="-1"></a>        <span class="at">aphia_id    =</span> aphia_id,</span>
<span id="cb9-587"><a href="#cb9-587" aria-hidden="true" tabindex="-1"></a>        <span class="at">val_min     =</span> vr[<span class="dv">1</span>],</span>
<span id="cb9-588"><a href="#cb9-588" aria-hidden="true" tabindex="-1"></a>        <span class="at">val_max     =</span> vr[<span class="dv">2</span>],</span>
<span id="cb9-589"><a href="#cb9-589" aria-hidden="true" tabindex="-1"></a>        <span class="at">rescale_min =</span> <span class="dv">0</span>,</span>
<span id="cb9-590"><a href="#cb9-590" aria-hidden="true" tabindex="-1"></a>        <span class="at">rescale_max =</span> <span class="dv">100</span>) )</span>
<span id="cb9-591"><a href="#cb9-591" aria-hidden="true" tabindex="-1"></a>  <span class="co"># message(glue("  nrow(lyrs_csv): {nrow(d)}"))</span></span>
<span id="cb9-592"><a href="#cb9-592" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(d, lyrs_csv)</span>
<span id="cb9-593"><a href="#cb9-593" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-594"><a href="#cb9-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-595"><a href="#cb9-595" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>